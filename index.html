<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="KiN">
    <title>KiN - The Kawa Family</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="kin.png">
    <link rel="icon" type="image/png" href="kin.png">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--black:#000;--white:#fff;--red:#ff3333;--grey-light:#f5f5f5;--grey:#999;--grey-dark:#333;--green:#4CAF50;--blue:#2196F3;--orange:#FF9800;--purple:#9C27B0}
        
        html,body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--white);
            color:var(--black);
            line-height:1.6;
            overflow-x:hidden;
            height:100%;
            width:100%;
            position:fixed;
            touch-action:manipulation;
        }
        
        #app-container{
            width:100%;
            height:100%;
            max-width:480px;
            margin:0 auto;
            position:relative;
            background:var(--white);
            overflow:hidden;
            box-shadow:0 0 50px rgba(0,0,0,0.1);
        }
        
        @media (min-width:481px){
            body{
                background:linear-gradient(135deg,#667eea,#764ba2);
                display:flex;
                align-items:center;
                justify-content:center;
                padding:20px;
            }
            #app-container{
                height:90vh;
                border-radius:40px;
                overflow:hidden;
                border:8px solid #1a1a1a;
            }
        }
        
        /* Splash with slow fade transition */
        #splash{
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:var(--white);
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            z-index:9999;
            transition:opacity 2s ease-in-out, visibility 2s;
        }
        #splash.hidden{
            opacity:0;
            visibility:hidden;
            pointer-events:none;
        }
        #splash.fade-out{
            animation:fadeOut 2s forwards;
        }
        @keyframes fadeOut{
            0%{opacity:1}
            100%{opacity:0;visibility:hidden}
        }
        .splash-logo-img{
            width:200px;
            height:200px;
            margin-bottom:30px;
            animation:pulse 2s infinite;
        }
        @keyframes pulse{
            0%,100%{transform:scale(1)}
            50%{transform:scale(1.05)}
        }
        .splash-subtitle{
            color:var(--grey);
            font-size:16px;
            letter-spacing:2px;
            animation:fadeInUp 1s ease-out;
        }
        @keyframes fadeInUp{
            from{opacity:0;transform:translateY(20px)}
            to{opacity:1;transform:translateY(0)}
        }
        
        /* Login screen with fade in */
        #login-screen{
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:var(--white);
            display:none;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            padding:40px 30px;
            z-index:9998;
            opacity:0;
            transition:opacity 0.5s ease-in-out;
        }
        #login-screen.active{
            display:flex;
            opacity:1;
        }
        #login-screen.fade-in{
            animation:fadeIn 0.8s forwards;
        }
        @keyframes fadeIn{
            from{opacity:0}
            to{opacity:1}
        }
        
        .login-box{width:100%;max-width:350px;text-align:center}
        .login-logo-img{width:120px;height:120px;margin-bottom:20px;animation:slideDown 0.6s ease-out}
        @keyframes slideDown{
            from{opacity:0;transform:translateY(-30px)}
            to{opacity:1;transform:translateY(0)}
        }
        .login-title{font-size:24px;font-weight:700;margin-bottom:5px;animation:fadeIn 0.6s 0.2s both}
        .login-subtitle{color:var(--grey);font-size:14px;margin-bottom:30px;animation:fadeIn 0.6s 0.3s both}
        
        .input-group{
            margin-bottom:20px;
            text-align:left;
            animation:fadeIn 0.6s 0.4s both;
        }
        .input-group label{
            display:block;
            font-size:12px;
            font-weight:600;
            color:var(--grey-dark);
            margin-bottom:8px;
            text-transform:uppercase;
            letter-spacing:1px;
        }
        .input-group input{
            width:100%;
            padding:16px;
            border:2px solid #e0e0e0;
            border-radius:12px;
            font-size:16px;
            background:var(--white);
            transition:border-color 0.2s;
        }
        .input-group input:focus{
            outline:none;
            border-color:var(--black);
        }
        
        .remember-me{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:20px;
            font-size:14px;
            color:var(--grey-dark);
            animation:fadeIn 0.6s 0.5s both;
        }
        .remember-me input[type="checkbox"]{
            width:20px;
            height:20px;
            accent-color:var(--black);
        }
        
        .btn{
            width:100%;
            padding:16px;
            border:none;
            border-radius:12px;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            transition:transform 0.2s, opacity 0.2s;
            animation:fadeIn 0.6s 0.6s both;
        }
        .btn:active{transform:scale(0.98)}
        .btn-primary{background:var(--black);color:var(--white)}
        .btn-primary:hover{opacity:0.9}
        
        #app{
            display:none;
            height:100%;
            padding-bottom:90px;
            overflow-y:auto;
            overflow-x:hidden;
            -webkit-overflow-scrolling:touch;
        }
        #app.active{display:block}
        
        .header{
            background:var(--white);
            padding:15px 20px;
            border-bottom:1px solid #f0f0f0;
            position:sticky;
            top:0;
            z-index:100;
        }
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .header-left{display:flex;align-items:center;gap:12px}
        .home-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            border:none;
            background:var(--grey-light);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:20px;
            transition:transform 0.2s;
        }
        .home-btn:active{transform:scale(0.95)}
        .header-logo-img{height:32px}
        .header-user{display:flex;align-items:center;gap:10px}
        .user-badge{
            background:var(--black);
            color:var(--white);
            padding:6px 12px;
            border-radius:20px;
            font-size:12px;
            font-weight:600;
        }
        .header-actions{display:flex;gap:10px}
        .icon-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            border:none;
            background:var(--grey-light);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:18px;
            transition:transform 0.2s;
        }
        .icon-btn:active{transform:scale(0.95)}
        
        .bottom-nav{
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            background:var(--white);
            border-top:1px solid #f0f0f0;
            padding:10px 0;
            z-index:100;
            padding-bottom:calc(10px + env(safe-area-inset-bottom));
        }
        .nav-items{display:flex;justify-content:space-around}
        .nav-item{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:4px;
            padding:5px 10px;
            cursor:pointer;
            border:none;
            background:none;
            color:var(--grey);
            font-size:10px;
            font-weight:500;
            transition:all 0.2s;
        }
        .nav-item.active{color:var(--black)}
        .nav-item svg{width:22px;height:22px;stroke-width:2}
        
        .section{display:none;padding:20px;animation:fadeIn .3s}
        .section.active{display:block}
        
        .filter-dropdown{
            width:100%;
            margin-bottom:20px;
            position:relative;
        }
        .filter-dropdown select{
            width:100%;
            padding:16px 20px;
            border:2px solid #e0e0e0;
            border-radius:12px;
            font-size:16px;
            font-weight:600;
            background:var(--white);
            appearance:none;
            -webkit-appearance:none;
            background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat:no-repeat;
            background-position:right 16px center;
            background-size:20px;
            padding-right:50px;
            cursor:pointer;
        }
        .filter-dropdown select:focus{outline:none;border-color:var(--black)}
        
        .activity-feed{display:flex;flex-direction:column;gap:15px}
        
        .activity-item{
            background:var(--white);
            border-radius:16px;
            padding:16px;
            border:1px solid #f0f0f0;
            animation:slideUp 0.4s ease-out;
            display:flex;
            gap:12px;
            align-items:flex-start;
        }
        @keyframes slideUp{
            from{opacity:0;transform:translateY(20px)}
            to{opacity:1;transform:translateY(0)}
        }
        
        .activity-avatar{
            width:44px;
            height:44px;
            border-radius:50%;
            background:var(--grey-light);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            font-size:16px;
            flex-shrink:0;
        }
        
        .activity-content{flex:1;min-width:0}
        .activity-header{
            display:flex;
            align-items:center;
            gap:8px;
            margin-bottom:6px;
            flex-wrap:wrap;
        }
        .activity-user{font-weight:700;font-size:15px}
        .activity-action{color:var(--grey);font-size:14px}
        .activity-time{font-size:12px;color:var(--grey);margin-left:auto}
        
        .activity-text{
            font-size:15px;
            line-height:1.5;
            margin-bottom:8px;
            word-wrap:break-word;
        }
        
        .activity-meta{
            display:flex;
            align-items:center;
            gap:12px;
            font-size:13px;
            color:var(--grey);
        }
        
        .activity-thumbnail{
            width:100%;
            max-width:200px;
            height:150px;
            border-radius:12px;
            margin-top:10px;
            cursor:pointer;
            overflow:hidden;
            position:relative;
            background:var(--grey-light);
        }
        .activity-thumbnail img{
            width:100%;
            height:100%;
            object-fit:cover;
            transition:transform 0.3s;
        }
        .activity-thumbnail:hover img{transform:scale(1.05)}
        .activity-thumbnail::after{
            content:'üîç Tap to expand';
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            background:rgba(0,0,0,0.6);
            color:white;
            font-size:12px;
            padding:8px;
            text-align:center;
            opacity:0;
            transition:opacity 0.3s;
        }
        .activity-thumbnail:hover::after{opacity:1}
        
        .image-modal{
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.95);
            z-index:9999;
            align-items:center;
            justify-content:center;
            padding:20px;
        }
        .image-modal.active{display:flex}
        .image-modal img{
            max-width:100%;
            max-height:90vh;
            object-fit:contain;
            border-radius:8px;
        }
        .image-modal-close{
            position:absolute;
            top:20px;
            right:20px;
            width:44px;
            height:44px;
            border-radius:50%;
            background:rgba(255,255,255,0.2);
            border:none;
            color:white;
            font-size:24px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        
        .activity-icon{
            width:32px;
            height:32px;
            border-radius:8px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:16px;
            margin-right:8px;
        }
        .icon-feed{background:#E3F2FD;color:var(--blue)}
        .icon-note{background:#F3E5F5;color:var(--purple)}
        .icon-reminder{background:#FFF3E0;color:var(--orange)}
        .icon-wishlist{background:#FFEBEE;color:var(--red)}
        .icon-event{background:#E8F5E9;color:var(--green)}
        .icon-task{background:#F5F5F5;color:var(--black)}
        
        .card{background:var(--white);border-radius:16px;padding:20px;margin-bottom:15px;border:1px solid #f0f0f0}
        
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .calendar-month{font-size:20px;font-weight:700}
        .calendar-nav{display:flex;gap:10px}
        .calendar-nav button{
            width:36px;
            height:36px;
            border-radius:50%;
            border:1px solid #e0e0e0;
            background:var(--white);
            cursor:pointer;
            font-size:16px;
            transition:all 0.2s;
        }
        .calendar-nav button:active{background:var(--grey-light)}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:30px}
        .calendar-day-header{text-align:center;font-size:12px;font-weight:600;color:var(--grey);padding:10px 0}
        .calendar-day{
            aspect-ratio:1;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:12px;
            font-size:14px;
            cursor:pointer;
            position:relative;
            transition:all 0.2s;
        }
        .calendar-day:active{background:var(--grey-light)}
        .calendar-day.active{background:var(--black);color:var(--white)}
        .calendar-day.has-event::after{
            content:'';
            position:absolute;
            bottom:6px;
            width:4px;
            height:4px;
            background:var(--red);
            border-radius:50%;
        }
        
        .event-item{
            display:flex;
            align-items:center;
            gap:15px;
            padding:16px;
            background:var(--white);
            border-radius:16px;
            margin-bottom:12px;
            border:1px solid #f0f0f0;
            border-left:4px solid var(--black);
        }
        .event-item.travel{border-left-color:var(--red)}
        .event-item.school{border-left-color:#4ecdc4}
        .event-time{text-align:center;min-width:45px}
        .event-day{font-weight:700;font-size:20px}
        .event-month{font-size:11px;color:var(--grey);text-transform:uppercase}
        .event-delete{background:none;border:none;color:var(--grey);font-size:18px;cursor:pointer;padding:5px}
        
        .todo-item{
            display:flex;
            align-items:center;
            gap:15px;
            padding:16px;
            background:var(--white);
            border-radius:16px;
            margin-bottom:12px;
            border:1px solid #f0f0f0;
        }
        .todo-checkbox{
            width:24px;
            height:24px;
            border:2px solid #e0e0e0;
            border-radius:50%;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all 0.2s;
        }
        .todo-checkbox.checked{background:var(--black);border-color:var(--black)}
        .todo-checkbox.checked::after{content:'‚úì';color:#fff;font-weight:bold;font-size:14px}
        .todo-text{flex:1}
        .todo-text.completed{text-decoration:line-through;color:var(--grey)}
        .todo-delete{background:none;border:none;color:var(--grey);font-size:18px;cursor:pointer;padding:5px}
        .todo-assignee{font-size:12px;color:var(--grey);display:block;margin-top:4px}
        
        .note-card{
            background:var(--grey-light);
            padding:20px;
            border-radius:16px;
            margin-bottom:15px;
            position:relative;
        }
        .note-card:nth-child(even){background:var(--black);color:var(--white)}
        .note-to{
            font-size:11px;
            font-weight:600;
            opacity:.6;
            margin-bottom:8px;
            text-transform:uppercase;
            letter-spacing:1px;
        }
        .note-text{font-size:16px;line-height:1.5;font-weight:500}
        .note-from{font-size:11px;margin-top:12px;opacity:.6;text-align:right}
        .note-delete{
            position:absolute;
            top:10px;
            right:10px;
            background:none;
            border:none;
            color:var(--grey);
            font-size:18px;
            cursor:pointer;
            padding:5px;
        }
        
        .reminder-item{
            display:flex;
            align-items:center;
            gap:15px;
            padding:16px;
            background:var(--white);
            border-radius:16px;
            margin-bottom:12px;
            border:1px solid #f0f0f0;
            border-left:4px solid var(--red);
        }
        .reminder-icon{
            width:44px;
            height:44px;
            border-radius:12px;
            background:var(--grey-light);
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:20px;
        }
        .reminder-content{flex:1}
        .reminder-title{font-weight:600;margin-bottom:4px}
        .reminder-time{font-size:12px;color:var(--grey)}
        .reminder-delete{background:none;border:none;color:var(--grey);font-size:18px;cursor:pointer;padding:5px}
        
        .wishlist-item{
            display:flex;
            gap:15px;
            padding:15px;
            background:var(--white);
            border-radius:16px;
            margin-bottom:12px;
            border:1px solid #f0f0f0;
        }
        .wishlist-image{
            width:80px;
            height:80px;
            border-radius:12px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:32px;
            background:linear-gradient(135deg,#fa709a,#fee140);
        }
        .wishlist-info{flex:1}
        .wishlist-title{font-weight:600;margin-bottom:5px;font-size:15px}
        .wishlist-price{color:var(--red);font-weight:700;font-size:18px;margin-bottom:5px}
        .wishlist-link{font-size:12px;color:var(--red);text-decoration:none;word-break:break-all}
        .bought-badge{
            background:var(--grey-light);
            color:var(--grey);
            padding:2px 8px;
            border-radius:10px;
            font-size:11px;
            margin-left:10px;
        }
        
        .fab-container{
            position:absolute;
            bottom:100px;
            right:20px;
            display:flex;
            flex-direction:column;
            align-items:flex-end;
            gap:10px;
            z-index:90;
        }
        
        .fab{
            width:60px;
            height:60px;
            border-radius:50%;
            background:var(--black);
            color:var(--white);
            border:none;
            font-size:28px;
            cursor:pointer;
            box-shadow:0 4px 20px rgba(0,0,0,.3);
            display:flex;
            align-items:center;
            justify-content:center;
            transition:transform 0.2s;
        }
        
        .fab-options{
            display:none;
            flex-direction:column;
            gap:10px;
            align-items:flex-end;
        }
        .fab-options.active{
            display:flex;
            animation:slideIn 0.3s ease-out;
        }
        @keyframes slideIn{
            from{opacity:0;transform:translateY(20px)}
            to{opacity:1;transform:translateY(0)}
        }
        
        .fab-option{
            display:flex;
            align-items:center;
            gap:10px;
            background:var(--white);
            padding:12px 20px;
            border-radius:25px;
            box-shadow:0 2px 10px rgba(0,0,0,0.1);
            border:none;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            white-space:nowrap;
        }
        
        .fab-option-icon{
            width:36px;
            height:36px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:18px;
        }
        
        .fab:active,.fab-option:active{transform:scale(0.95)}
        
        .modal{
            display:none;
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,.5);
            z-index:200;
            align-items:flex-end;
            justify-content:center;
        }
        .modal.active{display:flex}
        .modal-content{
            background:var(--white);
            width:100%;
            border-radius:24px 24px 0 0;
            padding:30px;
            animation:slideUp .3s;
            max-height:85vh;
            overflow-y:auto;
        }
        
        .modal-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:25px;
        }
        .modal-title{font-size:24px;font-weight:700}
        .close-btn{
            background:none;
            border:none;
            font-size:28px;
            cursor:pointer;
            color:var(--grey);
            width:40px;
            height:40px;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:50%;
            transition:background 0.2s;
        }
        .close-btn:active{background:var(--grey-light)}
        
        .form-group{margin-bottom:20px}
        .form-group label{
            display:block;
            margin-bottom:8px;
            font-weight:600;
            color:var(--grey-dark);
            font-size:14px;
        }
        .form-group input,.form-group textarea,.form-group select{
            width:100%;
            padding:16px;
            border:2px solid #e0e0e0;
            border-radius:12px;
            font-size:16px;
            font-family:inherit;
            -webkit-appearance:none;
        }
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{
            outline:none;
            border-color:var(--black);
        }
        .form-group textarea{resize:vertical;min-height:100px}
        
        .photo-preview{
            width:100%;
            height:200px;
            border-radius:12px;
            background:var(--grey-light);
            display:flex;
            align-items:center;
            justify-content:center;
            margin-bottom:15px;
            overflow:hidden;
            position:relative;
        }
        .photo-preview img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .photo-preview-placeholder{
            color:var(--grey);
            font-size:48px;
        }
        .photo-input{display:none}
        .photo-btn{
            width:100%;
            padding:16px;
            border:2px dashed #e0e0e0;
            border-radius:12px;
            background:var(--white);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            font-size:16px;
            color:var(--grey-dark);
            margin-bottom:15px;
            transition:all 0.2s;
        }
        .photo-btn:active{background:var(--grey-light)}
        
        .btn-secondary{background:var(--grey-light);color:var(--black);margin-top:10px}
        
        .empty-state{text-align:center;padding:60px 20px;color:var(--grey)}
        .empty-state-icon{font-size:64px;margin-bottom:20px}
        
        .pull-indicator{
            text-align:center;
            padding:20px;
            color:var(--grey);
            font-size:14px;
            display:none;
        }
        .pull-indicator.visible{display:block}
        
        .spinner{
            display:inline-block;
            width:20px;
            height:20px;
            border:3px solid rgba(255,255,255,.3);
            border-radius:50%;
            border-top-color:var(--white);
            animation:spin 1s ease-in-out infinite;
        }
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="app-container">
        <div id="splash">
            <img src="kin.png" alt="KiN" class="splash-logo-img">
            <div class="splash-subtitle">THE KAWA FAMILY</div>
        </div>
        
        <div id="login-screen">
            <div class="login-box">
                <img src="kin.png" alt="KiN" class="login-logo-img">
                <div class="login-title">Welcome Home</div>
                <div class="login-subtitle">The Kawa Family Portal</div>
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="Enter username (Kawa)" autocomplete="username">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter your first name" autocomplete="current-password">
                </div>
                <div class="remember-me">
                    <input type="checkbox" id="remember-me" checked>
                    <label for="remember-me" style="margin:0;cursor:pointer;">Remember me</label>
                </div>
                <button class="btn btn-primary" onclick="login()">
                    <span id="login-text">Enter KiN</span>
                </button>
            </div>
        </div>

        <div id="app">
            <div class="header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="home-btn" onclick="goHome()" title="Back to Feed">üè†</button>
                        <img src="kin.png" alt="KiN" class="header-logo-img">
                    </div>
                    <div class="header-user">
                        <span class="user-badge" id="user-badge"></span>
                        <div class="header-actions">
                            <button class="icon-btn" onclick="installApp()" id="install-btn" style="display:none" title="Install App">üì≤</button>
                            <button class="icon-btn" onclick="showNotifications()">üîî</button>
                            <button class="icon-btn" onclick="logout()">‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pull-indicator" id="pull-indicator">‚¨áÔ∏è Pull to refresh</div>

            <div class="section active" id="feed-section">
                <div class="filter-dropdown">
                    <select id="feed-filter" onchange="filterFeed(this.value)">
                        <option value="all">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Everyone's Activity</option>
                        <option value="ajay">üë§ Ajay's Activity</option>
                        <option value="lamies">üë§ Lamies's Activity</option>
                        <option value="amelle">üë§ Amelle's Activity</option>
                        <option value="elissa">üë§ Elissa's Activity</option>
                    </select>
                </div>
                <div id="feed-container" class="activity-feed"></div>
            </div>

            <div class="section" id="notes-section">
                <h2 class="section-title">Family Notes</h2>
                <div id="notes-container"></div>
            </div>

            <div class="section" id="reminders-section">
                <h2 class="section-title">Reminders</h2>
                <div id="reminders-container"></div>
            </div>

            <div class="section" id="wishlists-section">
                <div class="filter-dropdown">
                    <select id="wishlist-filter" onchange="filterWishlist(this.value)">
                        <option value="all">üéÅ All Wishlists</option>
                        <option value="ajay">üéÅ Ajay's Wishlist</option>
                        <option value="lamies">üéÅ Lamies's Wishlist</option>
                        <option value="amelle">üéÅ Amelle's Wishlist</option>
                        <option value="elissa">üéÅ Elissa's Wishlist</option>
                    </select>
                </div>
                <div id="wishlist-container"></div>
            </div>

            <div class="section" id="calendar-section">
                <h2 class="section-title">Family Calendar</h2>
                <div class="calendar-header">
                    <div class="calendar-month" id="calendar-month">February 2026</div>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">‚Üê</button>
                        <button onclick="changeMonth(1)">‚Üí</button>
                    </div>
                </div>
                <div class="card">
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>
                <h3 style="margin:25px 0 15px;font-size:18px;font-weight:600">Upcoming Events</h3>
                <div id="events-container"></div>
            </div>

            <div class="section" id="actions-section">
                <h2 class="section-title">Action Lists</h2>
                <div class="filter-dropdown">
                    <select id="actions-filter" onchange="filterActions(this.value)">
                        <option value="all">‚úÖ All Tasks</option>
                        <option value="ajay">‚úÖ Ajay's Tasks</option>
                        <option value="lamies">‚úÖ Lamies's Tasks</option>
                        <option value="amelle">‚úÖ Amelle's Tasks</option>
                        <option value="elissa">‚úÖ Elissa's Tasks</option>
                    </select>
                </div>
                <div id="actions-container"></div>
            </div>

            <div class="fab-container">
                <div class="fab-options" id="fab-options">
                    <button class="fab-option" onclick="openPhotoModal()">
                        <span>üì∏ Take Photo</span>
                        <div class="fab-option-icon" style="background:#E3F2FD">üì∑</div>
                    </button>
                    <button class="fab-option" onclick="openModal('feed')">
                        <span>üìù Add to Feed</span>
                        <div class="fab-option-icon" style="background:#F3E5F5">üí≠</div>
                    </button>
                    <button class="fab-option" onclick="openModal('note')">
                        <span>üíå Send Note</span>
                        <div class="fab-option-icon" style="background:#FFF3E0">‚úâÔ∏è</div>
                    </button>
                    <button class="fab-option" onclick="openModal('reminder')">
                        <span>‚è∞ Reminder</span>
                        <div class="fab-option-icon" style="background:#E8F5E9">üîî</div>
                    </button>
                    <button class="fab-option" onclick="openModal('wishlist')">
                        <span>üéÅ Wishlist</span>
                        <div class="fab-option-icon" style="background:#FFEBEE">üíù</div>
                    </button>
                    <button class="fab-option" onclick="openModal('event')">
                        <span>üìÖ Event</span>
                        <div class="fab-option-icon" style="background:#E0F2F1">üìÜ</div>
                    </button>
                    <button class="fab-option" onclick="openModal('task')">
                        <span>‚úÖ Task</span>
                        <div class="fab-option-icon" style="background:#F5F5F5">üìù</div>
                    </button>
                </div>
                <button class="fab" onclick="toggleFab()" id="main-fab">+</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-items">
                <button class="nav-item active" onclick="showSection('feed')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                    <span>Feed</span>
                </button>
                <button class="nav-item" onclick="showSection('notes')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <span>Notes</span>
                </button>
                <button class="nav-item" onclick="showSection('reminders')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg>
                    <span>Alerts</span>
                </button>
                <button class="nav-item" onclick="showSection('wishlists')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    <span>Wishlist</span>
                </button>
                <button class="nav-item" onclick="showSection('calendar')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span>Calendar</span>
                </button>
                <button class="nav-item" onclick="showSection('actions')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    <span>Tasks</span>
                </button>
            </div>
        </nav>

        <!-- Photo Modal -->
        <div class="modal" id="photo-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üì∏ Add Photo</h3>
                    <button class="close-btn" onclick="closePhotoModal()">√ó</button>
                </div>
                <div class="photo-preview" id="photo-preview">
                    <div class="photo-preview-placeholder">üì∑</div>
                </div>
                <input type="file" id="photo-input" class="photo-input" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
                <button class="photo-btn" onclick="document.getElementById('photo-input').click()">
                    üì∑ Take Photo or Choose from Library
                </button>
                <div class="form-group">
                    <label>Caption</label>
                    <input type="text" id="photo-caption" placeholder="What's happening?">
                </div>
                <button class="btn btn-primary" onclick="addPhotoToFeed()" id="share-photo-btn">Share to Feed</button>
                <button class="btn btn-secondary" onclick="closePhotoModal()">Cancel</button>
            </div>
        </div>

        <!-- Image Expand Modal -->
        <div class="image-modal" id="image-modal" onclick="closeImageModal()">
            <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
            <img src="" alt="Full size" id="expanded-image">
        </div>

        <!-- Add Item Modal -->
        <div class="modal" id="add-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-title">Add New</h3>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <div class="form-group" id="for-group">
                    <label>For</label>
                    <select id="item-for">
                        <option value="all">Everyone</option>
                        <option value="ajay">Ajay</option>
                        <option value="lamies">Lamies</option>
                        <option value="amelle">Amelle</option>
                        <option value="elissa">Elissa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="item-label">Title / Description</label>
                    <input type="text" id="item-title" placeholder="What's on your mind?">
                </div>
                <div class="form-group" id="price-group" style="display:none">
                    <label>Price (¬£)</label>
                    <input type="number" id="item-price" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group" id="link-group" style="display:none">
                    <label>Link (URL)</label>
                    <input type="url" id="item-link" placeholder="https://...">
                </div>
                <div class="form-group" id="date-group">
                    <label>Date</label>
                    <input type="date" id="item-date">
                </div>
                <div class="form-group" id="note-group" style="display:none">
                    <label>Message</label>
                    <textarea id="item-note" placeholder="Write your message..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addItem()">Add to KiN</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser=localStorage.getItem('kin_current_user')||null;
        let data={feed:JSON.parse(localStorage.getItem('kin_feed')||'[]'),notes:JSON.parse(localStorage.getItem('kin_notes')||'[]'),reminders:JSON.parse(localStorage.getItem('kin_reminders')||'[]'),wishlist:JSON.parse(localStorage.getItem('kin_wishlist')||'[]'),events:JSON.parse(localStorage.getItem('kin_events')||'[]'),tasks:JSON.parse(localStorage.getItem('kin_tasks')||'[]'),activities:JSON.parse(localStorage.getItem('kin_activities')||'[]')};
        const users={'Ajay':'ajay','Lamies':'lamies','Amelle':'amelle','Elissa':'elissa'};
        let deferredPrompt;
        let currentFilter='all';
        let currentPhotoData=null;
        let currentModalType='feed';
        let touchStartY=0;
        
        document.addEventListener('DOMContentLoaded',function(){
            const savedUser=localStorage.getItem('kin_saved_username');
            const savedPass=localStorage.getItem('kin_saved_password');
            const rememberMe=localStorage.getItem('kin_remember_me')==='true';
            
            if(savedUser && rememberMe){
                document.getElementById('username').value=savedUser;
                document.getElementById('password').value=savedPass;
                document.getElementById('remember-me').checked=true;
            }
            
            if(currentUser){
                setTimeout(()=>{
                    document.getElementById('splash').classList.add('fade-out');
                    setTimeout(()=>{
                        document.getElementById('splash').classList.add('hidden');
                        document.getElementById('app').classList.add('active');
                        document.getElementById('user-badge').textContent=Object.keys(users).find(k=>users[k]===currentUser);
                        generateCalendar();
                        renderAll();
                    },2000);
                },3000);
            }else{
                setTimeout(()=>{
                    document.getElementById('splash').classList.add('fade-out');
                    setTimeout(()=>{
                        document.getElementById('splash').classList.add('hidden');
                        document.getElementById('login-screen').classList.add('active');
                        document.getElementById('login-screen').classList.add('fade-in');
                    },2000);
                },3000);
            }
            
            setupPullToRefresh();
        });
        
        function login(){
            const u=document.getElementById('username').value.trim();
            const p=document.getElementById('password').value.trim();
            const remember=document.getElementById('remember-me').checked;
            
            if(u!=='Kawa'){alert('Username must be "Kawa"');return}
            
            const userKey=Object.keys(users).find(n=>n.toLowerCase()===p.toLowerCase());
            if(userKey){
                currentUser=users[userKey];
                
                if(remember){
                    localStorage.setItem('kin_saved_username',u);
                    localStorage.setItem('kin_saved_password',p);
                    localStorage.setItem('kin_remember_me','true');
                }else{
                    localStorage.removeItem('kin_saved_username');
                    localStorage.removeItem('kin_saved_password');
                    localStorage.setItem('kin_remember_me','false');
                }
                
                localStorage.setItem('kin_current_user',currentUser);
                
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('app').classList.add('active');
                document.getElementById('user-badge').textContent=userKey;
                generateCalendar();
                renderAll();
            }else{
                alert('Password must be your first name: Ajay, Lamies, Amelle, or Elissa');
            }
        }
        
        function logout(){
            currentUser=null;
            localStorage.removeItem('kin_current_user');
            document.getElementById('app').classList.remove('active');
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('username').value='';
            document.getElementById('password').value='';
            
            const rememberMe=localStorage.getItem('kin_remember_me')==='true';
            if(rememberMe){
                const savedUser=localStorage.getItem('kin_saved_username');
                const savedPass=localStorage.getItem('kin_saved_password');
                if(savedUser) document.getElementById('username').value=savedUser;
                if(savedPass) document.getElementById('password').value=savedPass;
                document.getElementById('remember-me').checked=true;
            }
        }
        
        function goHome(){
            showSection('feed');
            currentFilter='all';
            document.getElementById('feed-filter').value='all';
            renderFeed();
            window.scrollTo(0,0);
        }
        
        function showSection(s){
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(s+'-section').classList.add('active');
            
            const navItems=document.querySelectorAll('.nav-item');
            const sectionMap={'feed':0,'notes':1,'reminders':2,'wishlists':3,'calendar':4,'actions':5};
            if(sectionMap[s]!==undefined) navItems[sectionMap[s]].classList.add('active');
            
            document.getElementById('fab-options').classList.remove('active');
            document.getElementById('main-fab').textContent='+';
        }
        
        function toggleFab(){
            const options=document.getElementById('fab-options');
            const fab=document.getElementById('main-fab');
            if(options.classList.contains('active')){
                options.classList.remove('active');
                fab.textContent='+';
            }else{
                options.classList.add('active');
                fab.textContent='√ó';
            }
        }
        
        function openPhotoModal(){
            closeFabMenu();
            document.getElementById('photo-modal').classList.add('active');
            currentPhotoData=null;
            document.getElementById('photo-preview').innerHTML='<div class="photo-preview-placeholder">üì∑</div>';
            document.getElementById('photo-caption').value='';
            document.getElementById('share-photo-btn').textContent='Share to Feed';
            document.getElementById('share-photo-btn').disabled=false;
        }
        
        function closePhotoModal(){
            document.getElementById('photo-modal').classList.remove('active');
        }
        
        function handlePhotoSelect(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=function(e){
                    currentPhotoData=e.target.result;
                    document.getElementById('photo-preview').innerHTML=`<img src="${currentPhotoData}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function addPhotoToFeed(){
            if(!currentPhotoData){
                alert('Please select a photo first');
                return;
            }
            
            const caption=document.getElementById('photo-caption').value.trim();
            const btn=document.getElementById('share-photo-btn');
            
            btn.disabled=true;
            btn.innerHTML='<span class="spinner"></span> Sharing...';
            
            setTimeout(()=>{
                const newItem={
                    timestamp:Date.now(),
                    author:currentUser||'ajay',
                    for:'all',
                    text:caption||'üì∏ Shared a photo',
                    image:currentPhotoData,
                    type:'feed'
                };
                
                data.feed.push(newItem);
                addActivity(currentUser||'ajay','shared a photo',caption||'üì∏ Photo',currentPhotoData);
                
                saveData();
                renderAll();
                closePhotoModal();
                
                currentPhotoData=null;
                document.getElementById('photo-caption').value='';
                document.getElementById('photo-preview').innerHTML='<div class="photo-preview-placeholder">üì∑</div>';
                btn.textContent='Share to Feed';
                btn.disabled=false;
            },500);
        }
        
        function expandImage(src){
            document.getElementById('expanded-image').src=src;
            document.getElementById('image-modal').classList.add('active');
        }
        
        function closeImageModal(){
            document.getElementById('image-modal').classList.remove('active');
        }
        
        function addActivity(user,action,itemText,image=null){
            const activity={
                timestamp:Date.now(),
                user:user,
                action:action,
                text:itemText,
                image:image,
                type:getActivityType(action)
            };
            data.activities.unshift(activity);
            if(data.activities.length>100) data.activities=data.activities.slice(0,100);
            localStorage.setItem('kin_activities',JSON.stringify(data.activities));
        }
        
        function getActivityType(action){
            if(action.includes('photo')) return 'feed';
            if(action.includes('note')) return 'note';
            if(action.includes('reminder')) return 'reminder';
            if(action.includes('wishlist')||action.includes('wish')) return 'wishlist';
            if(action.includes('event')||action.includes('calendar')) return 'event';
            if(action.includes('task')) return 'task';
            return 'general';
        }
        
        function getActivityIcon(type){
            const icons={feed:'üì∏',note:'üíå',reminder:'‚è∞',wishlist:'üéÅ',event:'üìÖ',task:'‚úÖ',general:'üìå'};
            return icons[type]||'üìå';
        }
        
        function getActivityColor(type){
            const colors={feed:'icon-feed',note:'icon-note',reminder:'icon-reminder',wishlist:'icon-wishlist',event:'icon-event',task:'icon-task',general:''};
            return colors[type]||'';
        }
        
        let currentMonth=new Date();
        function generateCalendar(){
            const g=document.getElementById('calendar-grid');
            g.innerHTML='';
            const d=['S','M','T','W','T','F','S'];
            d.forEach(x=>{
                const e=document.createElement('div');
                e.className='calendar-day-header';
                e.textContent=x;
                g.appendChild(e);
            });
            const y=currentMonth.getFullYear();
            const m=currentMonth.getMonth();
            const dim=new Date(y,m+1,0).getDate();
            const fd=new Date(y,m,1).getDay();
            document.getElementById('calendar-month').textContent=currentMonth.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
            for(let i=0;i<fd;i++)g.appendChild(document.createElement('div'));
            for(let i=1;i<=dim;i++){
                const e=document.createElement('div');
                e.className='calendar-day';
                const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                if(data.events.some(ev=>ev.date===ds))e.classList.add('has-event');
                if(i===new Date().getDate()&&m===new Date().getMonth()&&y===new Date().getFullYear())e.classList.add('active');
                e.textContent=i;
                g.appendChild(e);
            }
        }
        
        function changeMonth(dir){
            currentMonth.setMonth(currentMonth.getMonth()+dir);
            generateCalendar();
        }
        
        function renderAll(){
            renderFeed();
            renderNotes();
            renderReminders();
            renderWishlist();
            renderEvents();
            renderTasks();
        }
        
        function renderFeed(){
            const c=document.getElementById('feed-container');
            let allActivities=[...data.activities];
            
            if(allActivities.length===0 && data.feed.length>0){
                data.feed.forEach(item=>{
                    allActivities.push({
                        timestamp:item.timestamp,
                        user:item.author,
                        action:'shared an update',
                        text:item.text,
                        image:item.image,
                        type:'feed'
                    });
                });
            }
            
            if(currentFilter!=='all'){
                allActivities=allActivities.filter(a=>a.user===currentFilter);
            }
            
            if(allActivities.length===0){
                c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üì±</div><h3>No activity yet</h3><p>Be the first to share something!</p></div>';
                return;
            }
            
            c.innerHTML=allActivities.sort((a,b)=>b.timestamp-a.timestamp).map(activity=>{
                const userName=activity.user.charAt(0).toUpperCase()+activity.user.slice(1);
                const timeAgo=getTimeAgo(activity.timestamp);
                const icon=getActivityIcon(activity.type);
                const iconClass=getActivityColor(activity.type);
                const hasImage=activity.image && activity.image.startsWith('data:');
                
                return`<div class="activity-item" data-person="${activity.user}">
                    <div class="activity-avatar">${activity.user[0].toUpperCase()}</div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <span class="activity-user">${userName}</span>
                            <span class="activity-action">${activity.action}</span>
                            <span class="activity-time">${timeAgo}</span>
                        </div>
                        <div class="activity-text">${activity.text}</div>
                        ${hasImage?`<div class="activity-thumbnail" onclick="expandImage('${activity.image}')"><img src="${activity.image}" alt="Photo"></div>`:''}
                        <div class="activity-meta">
                            <span class="activity-icon ${iconClass}">${icon}</span>
                            <span>${new Date(activity.timestamp).toLocaleDateString('en-GB')}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function getTimeAgo(timestamp){
            const seconds=Math.floor((Date.now()-timestamp)/1000);
            if(seconds<60) return 'Just now';
            const minutes=Math.floor(seconds/60);
            if(minutes<60) return `${minutes}m ago`;
            const hours=Math.floor(minutes/60);
            if(hours<24) return `${hours}h ago`;
            const days=Math.floor(hours/24);
            if(days<7) return `${days}d ago`;
            return new Date(timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
        }
        
        function filterFeed(value){
            currentFilter=value;
            renderFeed();
        }
        
        function renderNotes(){
            const c=document.getElementById('notes-container');
            if(data.notes.length===0){
                c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üíå</div><h3>No notes yet</h3><p>Leave a message for your family!</p></div>';
                return;
            }
            c.innerHTML=data.notes.sort((a,b)=>b.timestamp-a.timestamp).map((note,idx)=>{
                const toName=note.to==='all'?'Everyone':note.to.charAt(0).toUpperCase()+note.to.slice(1);
                const fromName=note.from.charAt(0).toUpperCase()+note.from.slice(1);
                return`<div class="note-card">
                    <button class="note-delete" onclick="deleteItem('notes',${idx})">√ó</button>
                    <div class="note-to">To: ${toName}</div>
                    <div class="note-text">${note.text}</div>
                    <div class="note-from">From: ${fromName} ‚Ä¢ ${new Date(note.timestamp).toLocaleDateString('en-GB')}</div>
                </div>`;
            }).join('');
        }
        
        function renderReminders(){
            const c=document.getElementById('reminders-container');
            if(data.reminders.length===0){
                c.innerHTML='<div class="empty-state"><div class="empty-state-icon">‚è∞</div><h3>No reminders</h3><p>Set your first reminder!</p></div>';
                return;
            }
            c.innerHTML=data.reminders.sort((a,b)=>new Date(a.date)-new Date(b.date)).map((item,idx)=>{
                const forName=item.for==='all'?'Everyone':item.for.charAt(0).toUpperCase()+item.for.slice(1);
                return`<div class="reminder-item">
                    <div class="reminder-icon">‚è∞</div>
                    <div class="reminder-content">
                        <div class="reminder-title">${item.title}</div>
                        <div class="reminder-time">${new Date(item.date).toLocaleDateString('en-GB')} ‚Ä¢ ${forName}</div>
                    </div>
                    <button class="reminder-delete" onclick="deleteItem('reminders',${idx})">√ó</button>
                </div>`;
            }).join('');
        }
        
        function renderWishlist(){
            const c=document.getElementById('wishlist-container');
            const filter=document.getElementById('wishlist-filter').value;
            let displayData=data.wishlist;
            
            if(filter!=='all'){
                displayData=data.wishlist.filter(item=>item.for===filter);
            }
            
            if(displayData.length===0){
                c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üéÅ</div><h3>Wishlist empty</h3><p>Add your first wish!</p></div>';
                return;
            }
            
            c.innerHTML=displayData.map((item,idx)=>{
                const forName=item.for.charAt(0).toUpperCase()+item.for.slice(1);
                return`<div class="wishlist-item" data-person="${item.for}">
                    <div class="wishlist-image">üéÅ</div>
                    <div class="wishlist-info">
                        <div class="wishlist-title">${item.title}${item.bought?'<span class="bought-badge">Bought</span>':''}</div>
                        <div class="wishlist-price">¬£${item.price}</div>
                        ${item.link?`<a href="${item.link}" target="_blank" class="wishlist-link">${item.link}</a>`:''}
                        <span class="todo-assignee">${forName}'s List</span>
                    </div>
                    ${currentUser!==item.for?`<button onclick="toggleBought(${idx})" style="background:${item.bought?'var(--grey-light)':'var(--red)'};color:${item.bought?'var(--grey)':'white'};border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px">${item.bought?'Bought':'Mark Bought'}</button>`:''}
                </div>`;
            }).join('');
        }
        
        function renderEvents(){
            const c=document.getElementById('events-container');
            if(data.events.length===0){
                c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìÖ</div><h3>No events</h3><p>Add your first event!</p></div>';
                return;
            }
            c.innerHTML=data.events.sort((a,b)=>new Date(a.date)-new Date(b.date)).map((event,idx)=>{
                const d=new Date(event.date);
                const tc=event.type==='travel'?'travel':event.type==='school'?'school':'';
                const forName=event.for==='all'?'Everyone':event.for.charAt(0).toUpperCase()+event.for.slice(1);
                return`<div class="event-item ${tc}">
                    <div class="event-time">
                        <div class="event-day">${d.getDate()}</div>
                        <div class="event-month">${d.toLocaleDateString('en-GB',{month:'short'})}</div>
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:600">${event.title}</div>
                        <div style="font-size:13px;color:var(--grey)">${forName} ‚Ä¢ ${event.type}</div>
                    </div>
                    <button class="event-delete" onclick="deleteItem('events',${idx})">√ó</button>
                </div>`;
            }).join('');
        }
        
        function renderTasks(){
            const c=document.getElementById('actions-container');
            const filter=document.getElementById('actions-filter').value;
            let displayData=data.tasks;
            
            if(filter!=='all'){
                displayData=data.tasks.filter(item=>item.for===filter);
            }
            
            if(displayData.length===0){
                c.innerHTML='<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><h3>No tasks</h3><p>Create your first task!</p></div>';
                return;
            }
            
            c.innerHTML=displayData.map((task,idx)=>{
                const forName=task.for.charAt(0).toUpperCase()+task.for.slice(1);
                return`<div class="todo-item" data-person="${task.for}">
                    <div class="todo-checkbox ${task.completed?'checked':''}" onclick="toggleTask(${idx})"></div>
                    <div class="todo-text ${task.completed?'completed':''}">
                        <div>${task.title}</div>
                        <span class="todo-assignee">For: ${forName}</span>
                    </div>
                    <button class="todo-delete" onclick="deleteItem('tasks',${idx})">√ó</button>
                </div>`;
            }).join('');
        }
        
        function toggleTask(idx){
            const task=data.tasks[idx];
            task.completed=!task.completed;
            addActivity(currentUser||'ajay',task.completed?'completed a task':'updated a task',task.title);
            saveData();
            renderTasks();
            renderFeed();
        }
        
        function toggleBought(idx){
            const item=data.wishlist[idx];
            item.bought=!item.bought;
            addActivity(currentUser||'ajay',item.bought?'bought a wishlist item':'updated wishlist',item.title);
            saveData();
            renderWishlist();
            renderFeed();
        }
        
        function deleteItem(type,idx){
            if(confirm('Delete this item?')){
                const item=data[type][idx];
                data[type].splice(idx,1);
                saveData();
                renderAll();
            }
        }
        
        function saveData(){
            Object.keys(data).forEach(key=>localStorage.setItem('kin_'+key,JSON.stringify(data[key])));
        }
        
        function closeFabMenu(){
            document.getElementById('fab-options').classList.remove('active');
            document.getElementById('main-fab').textContent='+';
        }
        
        function openModal(type){
            closeFabMenu();
            currentModalType=type;
            const titles={feed:'üìù Add to Feed',note:'üíå Send Note',reminder:'‚è∞ Add Reminder',wishlist:'üéÅ Add to Wishlist',event:'üìÖ Add Event',task:'‚úÖ Add Task'};
            
            document.getElementById('modal-title').textContent=titles[type]||'Add New';
            document.getElementById('add-modal').classList.add('active');
            document.getElementById('item-date').valueAsDate=new Date();
            document.getElementById('item-for').value=currentUser||'all';
            
            document.getElementById('price-group').style.display=type==='wishlist'?'block':'none';
            document.getElementById('link-group').style.display=(type==='wishlist'||type==='feed')?'block':'none';
            document.getElementById('note-group').style.display=type==='note'?'block':'none';
            document.getElementById('date-group').style.display=(type==='note'||type==='feed')?'none':'block';
            document.getElementById('for-group').style.display=type==='note'?'block':'none';
            document.getElementById('item-label').textContent=type==='note'?'Note Title':'Title / Description';
            
            document.getElementById('item-title').value='';
            document.getElementById('item-price').value='';
            document.getElementById('item-link').value='';
            document.getElementById('item-note').value='';
        }
        
        function closeModal(){
            document.getElementById('add-modal').classList.remove('active');
        }
        
        function addItem(){
            const fp=document.getElementById('item-for').value;
            const title=document.getElementById('item-title').value.trim();
            const price=document.getElementById('item-price').value;
            const link=document.getElementById('item-link').value.trim();
            const date=document.getElementById('item-date').value;
            const noteText=document.getElementById('item-note').value.trim();
            
            if(!title && !noteText){
                alert('Please enter a title or message');
                return;
            }
            
            const user=currentUser||'ajay';
            const userName=user.charAt(0).toUpperCase()+user.slice(1);
            
            switch(currentModalType){
                case'feed':
                    const feedItem={timestamp:Date.now(),author:user,for:'all',text:title||noteText,link:link,type:'feed'};
                    data.feed.push(feedItem);
                    addActivity(user,'shared an update',feedItem.text);
                    break;
                case'note':
                    const noteItem={timestamp:Date.now(),text:noteText||title,to:fp||'all',from:user};
                    data.notes.push(noteItem);
                    const toName=fp==='all'?'everyone':fp;
                    addActivity(user,`sent a note to ${toName}`,noteItem.text);
                    break;
                case'reminder':
                    const remItem={timestamp:Date.now(),title:title,date:date||new Date().toISOString().split('T')[0],for:user};
                    data.reminders.push(remItem);
                    addActivity(user,'added a reminder',remItem.title);
                    break;
                case'wishlist':
                    const wishItem={timestamp:Date.now(),title:title,price:price||'0',link:link,bought:false,for:user};
                    data.wishlist.push(wishItem);
                    addActivity(user,'added to wishlist',wishItem.title);
                    break;
                case'event':
                    const eventItem={timestamp:Date.now(),title:title,date:date||new Date().toISOString().split('T')[0],type:'general',for:'all'};
                    data.events.push(eventItem);
                    addActivity(user,'added a calendar event',eventItem.title);
                    break;
                case'task':
                    const taskItem={timestamp:Date.now(),title:title,completed:false,for:fp||user};
                    data.tasks.push(taskItem);
                    const taskFor=fp==='all'?'everyone':fp||'themselves';
                    addActivity(user,`created a task for ${taskFor}`,taskItem.title);
                    break;
            }
            
            saveData();
            renderAll();
            closeModal();
        }
        
        function filterWishlist(value){
            document.getElementById('wishlist-filter').value=value;
            renderWishlist();
        }
        
        function filterActions(value){
            document.getElementById('actions-filter').value=value;
            renderTasks();
        }
        
        function showNotifications(){
            const count=data.reminders.length+data.tasks.filter(t=>!t.completed).length;
            alert(`üîî You have ${count} pending items`);
        }
        
        function setupPullToRefresh(){
            const app=document.getElementById('app');
            const indicator=document.getElementById('pull-indicator');
            
            app.addEventListener('touchstart',function(e){
                if(app.scrollTop===0){
                    touchStartY=e.touches[0].clientY;
                }
            },{passive:true});
            
            app.addEventListener('touchmove',function(e){
                if(app.scrollTop===0){
                    const touchY=e.touches[0].clientY;
                    const diff=touchY-touchStartY;
                    if(diff>0 && diff<100){
                        indicator.classList.add('visible');
                        indicator.style.transform=`translateY(${diff/2}px)`;
                    }
                }
            },{passive:true});
            
            app.addEventListener('touchend',function(e){
                const touchY=e.changedTouches[0].clientY;
                const diff=touchY-touchStartY;
                
                if(diff>80 && app.scrollTop===0){
                    indicator.textContent='üîÑ Refreshing...';
                    setTimeout(()=>{
                        renderAll();
                        indicator.classList.remove('visible');
                        indicator.textContent='‚¨áÔ∏è Pull to refresh';
                        indicator.style.transform='';
                    },1000);
                }else{
                    indicator.classList.remove('visible');
                    indicator.style.transform='';
                }
            });
        }
        
        document.getElementById('add-modal').addEventListener('click',function(e){
            if(e.target===this) closeModal();
        });
        document.getElementById('photo-modal').addEventListener('click',function(e){
            if(e.target===this) closePhotoModal();
        });
        
        window.addEventListener('beforeinstallprompt',(e)=>{
            e.preventDefault();
            deferredPrompt=e;
            document.getElementById('install-btn').style.display='flex';
        });
        
        function installApp(){
            if(deferredPrompt){
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult)=>{
                    if(choiceResult.outcome==='accepted'){
                        document.getElementById('install-btn').style.display='none';
                    }
                    deferredPrompt=null;
                });
            }else{
                alert('To install: Tap Share button ‚Üí Add to Home Screen');
            }
        }
        
        if('serviceWorker'in navigator){
            navigator.serviceWorker.register('service-worker.js');
        }
        
        let lastTouchEnd=0;
        document.addEventListener('touchend',function(e){
            const now=Date.now();
            if(now-lastTouchEnd<=300){
                e.preventDefault();
            }
            lastTouchEnd=now;
        },false);
    </script>
</body>
</html>
