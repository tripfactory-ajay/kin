<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="KiN">
  <title>KiN ‚Äì The Kawa Family</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="kin.png">
  <link rel="icon" type="image/png" href="kin.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,600;0,700;1,300&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --ink:#0d0d0d;--paper:#faf9f7;--cream:#f2efe8;
  --red:#e5342a;--red-bg:#fdf1f0;
  --wg:#9a9387;--mg:#cdc9c0;--lg:#ece8e1;
  --green:#1a8a5a;--blue:#1454d4;--orange:#df7818;--purple:#6a3ea0;--pink:#be185a;
  --s1:0 1px 4px rgba(0,0,0,.07);--s2:0 4px 18px rgba(0,0,0,.09);--s3:0 14px 40px rgba(0,0,0,.13);
  --r:13px;--rl:20px;--rx:30px;
}
html,body{font-family:'Nunito',sans-serif;background:var(--paper);color:var(--ink);line-height:1.5;overflow-x:hidden;height:100%;width:100%;position:fixed;touch-action:manipulation}
#wrap{width:100%;height:100%;max-width:480px;margin:0 auto;position:relative;background:var(--paper);overflow:hidden}
@media(min-width:481px){
  body{background:#100d07;background-image:radial-gradient(ellipse 80% 55% at 50% -10%,#2a1e0c,#060503);display:flex;align-items:center;justify-content:center;padding:20px}
  #wrap{height:92vh;border-radius:46px;border:7px solid #1a1208;box-shadow:var(--s3),0 0 0 1px rgba(255,220,130,.05)}
}

/* SPLASH */
#splash{position:absolute;inset:0;background:var(--paper);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;transition:opacity .9s,visibility .9s}
#splash.gone{opacity:0;visibility:hidden;pointer-events:none}
.slogo{width:158px;height:158px;animation:breathe 2.4s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.sfam{margin-top:20px;font-family:'Fraunces',serif;font-size:11px;letter-spacing:5px;color:var(--wg);text-transform:uppercase;animation:rise 1s .5s both}
@keyframes rise{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* LOGIN */
#login{position:absolute;inset:0;background:var(--paper);display:none;flex-direction:column;justify-content:center;align-items:center;padding:40px 26px;z-index:9998}
#login.on{display:flex}
.lwrap{width:100%;max-width:330px;text-align:center}
.llogo{width:86px;height:86px;margin-bottom:18px;animation:rise .5s both}
.lh{font-family:'Fraunces',serif;font-size:32px;font-weight:300;margin-bottom:4px;animation:rise .5s .07s both}
.ls{color:var(--wg);font-size:13px;margin-bottom:30px;animation:rise .5s .14s both}
.field{position:relative;margin-bottom:13px;animation:rise .5s .2s both}
.field label{position:absolute;top:-8px;left:12px;background:var(--paper);padding:0 4px;font-size:10px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:var(--wg)}
.field input{width:100%;padding:14px 15px;border:1.5px solid var(--mg);border-radius:var(--r);font-size:16px;font-family:'Nunito',sans-serif;background:var(--cream);transition:border .2s,box-shadow .2s}
.field input:focus{outline:none;border-color:var(--ink);box-shadow:0 0 0 3px rgba(13,13,13,.06)}
.remrow{display:flex;align-items:center;gap:8px;margin-bottom:18px;font-size:13px;color:var(--wg);animation:rise .5s .28s both}
.remrow input{width:17px;height:17px;accent-color:var(--ink);cursor:pointer}
.lbtn{width:100%;padding:15px;background:var(--ink);color:white;border:none;border-radius:var(--r);font-size:15px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;transition:opacity .2s,transform .15s;letter-spacing:.3px;animation:rise .5s .34s both}
.lbtn:active{transform:scale(.98)}
.lhint{font-size:11px;color:var(--wg);margin-top:11px;animation:rise .5s .4s both}

/* APP */
#app{display:none;height:100%;flex-direction:column}
#app.on{display:flex}

/* HEADER */
.hdr{padding:11px 15px;background:rgba(250,249,247,.96);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--lg);flex-shrink:0;position:sticky;top:0;z-index:100}
.hrow{display:flex;justify-content:space-between;align-items:center}
.hl{display:flex;align-items:center;gap:8px}
.hbtn{width:35px;height:35px;border-radius:50%;border:none;background:var(--lg);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:background .2s,transform .15s}
.hbtn:active{transform:scale(.9)}
.hlogo{height:27px}
.ldot{width:7px;height:7px;border-radius:50%;background:var(--mg);transition:background .3s}
.ldot.go{background:var(--green);animation:lp 2s infinite}
@keyframes lp{0%,100%{opacity:1}50%{opacity:.3}}
.hr{display:flex;align-items:center;gap:6px}
.utag{background:var(--ink);color:white;padding:4px 10px;border-radius:18px;font-size:10px;font-weight:800;letter-spacing:.5px;text-transform:uppercase}
.ibtn{width:35px;height:35px;border-radius:50%;border:none;background:var(--lg);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:background .2s,transform .15s;position:relative}
.ibtn:active{transform:scale(.9)}
.nbdge{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;background:var(--red);color:white;border-radius:10px;font-size:9px;font-weight:800;display:none;align-items:center;justify-content:center;border:2px solid var(--paper);padding:0 3px}

/* BODY */
#body{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:84px}

/* SECTIONS */
.sec{display:none;padding:15px;animation:rise .25s}
.sec.on{display:block}
.sch{font-family:'Fraunces',serif;font-size:25px;font-weight:300;margin-bottom:15px}

/* BOTTOM NAV */
.bnav{position:absolute;bottom:0;left:0;right:0;background:rgba(250,249,247,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--lg);padding:5px 0;padding-bottom:calc(5px + env(safe-area-inset-bottom));z-index:100}
.nrow{display:flex;justify-content:space-around}
.ni{display:flex;flex-direction:column;align-items:center;gap:2px;padding:5px 7px;cursor:pointer;border:none;background:none;color:var(--wg);font-size:9px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;font-family:'Nunito',sans-serif;transition:color .2s;position:relative}
.ni.on{color:var(--ink)}
.ni svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;transition:stroke .2s}
.nbdg{position:absolute;top:0;right:1px;min-width:15px;height:15px;background:var(--red);color:white;border-radius:10px;font-size:8px;font-weight:800;display:none;align-items:center;justify-content:center;padding:0 3px}
.nbdg.on{display:flex}

/* FILTER */
.fsel{width:100%;padding:11px 13px;border:1.5px solid var(--mg);border-radius:var(--r);font-size:14px;font-weight:600;font-family:'Nunito',sans-serif;background:var(--cream);-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%239a9387' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;padding-right:36px;cursor:pointer;margin-bottom:14px;transition:border .2s}
.fsel:focus{outline:none;border-color:var(--ink)}

/* FEED */
.feed-list{display:flex;flex-direction:column;gap:10px}
.fcard{background:white;border-radius:var(--rl);padding:13px;border:1px solid var(--lg);box-shadow:var(--s1);display:flex;gap:10px;align-items:flex-start;animation:rise .3s}
.av{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;flex-shrink:0;color:white;font-family:'Fraunces',serif}
.av.baba{background:linear-gradient(135deg,#1454d4,#0a34a0)}
.av.mama{background:linear-gradient(135deg,#be185a,#7c1140)}
.av.amelle{background:linear-gradient(135deg,#6a3ea0,#421880)}
.av.elissa{background:linear-gradient(135deg,#1a8a5a,#0d5c3a)}
.av.family{background:linear-gradient(135deg,#df7818,#a04800)}
.fbody{flex:1;min-width:0}
.ftop{display:flex;align-items:baseline;gap:5px;margin-bottom:3px;flex-wrap:wrap}
.fn{font-weight:800;font-size:13px}
.fv{color:var(--wg);font-size:12px}
.ft{font-size:10px;color:var(--wg);margin-left:auto;flex-shrink:0}
.ftext{font-size:14px;line-height:1.5;word-break:break-word;margin-bottom:5px}
.fchip{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:800;padding:2px 7px;border-radius:18px;background:var(--lg);color:var(--wg);letter-spacing:.3px;text-transform:uppercase}
.floc{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 7px;border-radius:18px;background:#dfeeff;color:#1454d4;margin-left:4px}
.fimg{width:100%;border-radius:var(--r);margin-top:8px;max-height:230px;object-fit:cover;cursor:pointer;transition:opacity .2s}
.fimg:active{opacity:.8}

/* NOTES */
.ncard{border-radius:var(--rl);padding:17px;position:relative;animation:rise .3s;margin-bottom:10px}
.ncard.lt{background:var(--cream);border:1px solid var(--mg)}
.ncard.dk{background:var(--ink);color:white}
.ncard.dk .nmeta{color:rgba(255,255,255,.3)}
.nto{font-size:9px;font-weight:800;letter-spacing:1.2px;text-transform:uppercase;opacity:.4;margin-bottom:6px}
.ntext{font-size:15px;line-height:1.6;font-family:'Fraunces',serif;font-weight:300}
.nmeta{font-size:10px;color:var(--wg);margin-top:10px;display:flex;justify-content:space-between}
.ndel{position:absolute;top:9px;right:9px;background:none;border:none;font-size:18px;color:currentColor;opacity:.22;cursor:pointer;padding:4px;border-radius:50%;transition:opacity .2s}
.ndel:active{opacity:.6}

/* CHAT */
.cmsgs{display:flex;flex-direction:column;gap:8px;padding:0 0 72px;min-height:160px}
.bbl{max-width:76%;padding:10px 13px;border-radius:17px;animation:rise .2s}
.bout{align-self:flex-end;background:var(--ink);color:white;border-bottom-right-radius:4px}
.bin{align-self:flex-start;background:white;color:var(--ink);border-bottom-left-radius:4px;border:1px solid var(--lg)}
.bwho{font-size:10px;font-weight:800;opacity:.5;margin-bottom:2px;letter-spacing:.2px}
.btxt{font-size:14px;line-height:1.4}
.btime{font-size:9px;opacity:.4;margin-top:3px;text-align:right}
.cbar{position:absolute;bottom:84px;left:13px;right:13px;display:flex;gap:6px;align-items:center;background:white;border:1.5px solid var(--mg);border-radius:26px;padding:4px 4px 4px 13px;box-shadow:var(--s2);z-index:80}
.cinp{flex:1;border:none;outline:none;font-size:15px;background:transparent;font-family:'Nunito',sans-serif}
.csend{width:36px;height:36px;border-radius:50%;background:var(--ink);color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:transform .15s;flex-shrink:0}
.csend:active{transform:scale(.88)}

/* CALENDAR */
.calhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:13px}
.calmon{font-family:'Fraunces',serif;font-size:21px;font-weight:300}
.calnav{display:flex;gap:5px}
.calnav button{width:30px;height:30px;border-radius:50%;border:1.5px solid var(--mg);background:white;cursor:pointer;font-size:13px;transition:background .2s}
.calnav button:active{background:var(--lg)}
.cgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:20px}
.cdh{text-align:center;font-size:9px;font-weight:800;color:var(--wg);padding:6px 0;letter-spacing:.5px}
.cd{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:13px;cursor:pointer;position:relative;transition:background .15s;color:var(--ink);font-weight:600}
.cd:active{background:var(--lg)}
.cd.today{background:var(--ink);color:white;font-weight:800}
.cd.hase::after{content:'';position:absolute;bottom:3px;width:3px;height:3px;background:var(--red);border-radius:50%}
.cd.today.hase::after{background:white}
.evrow{display:flex;align-items:center;gap:11px;padding:12px 13px;border-radius:var(--r);background:white;border:1px solid var(--lg);margin-bottom:8px;border-left:3px solid var(--ink)}
.evrow.school{border-left-color:#00bcd4}
.evrow.work{border-left-color:var(--orange)}
.evrow.home{border-left-color:var(--green)}
.evrow.travel{border-left-color:var(--red)}
.evrow.sport{border-left-color:var(--purple)}
.evrow.medical{border-left-color:var(--pink)}
.evd{text-align:center;min-width:35px}
.evday{font-weight:800;font-size:18px;font-family:'Fraunces',serif}
.evmon{font-size:9px;color:var(--wg);text-transform:uppercase;letter-spacing:.5px}
.evdel{background:none;border:none;color:var(--wg);font-size:16px;cursor:pointer;padding:3px}

/* TASKS */
.trow{display:flex;align-items:center;gap:10px;padding:12px 13px;border-radius:var(--r);background:white;border:1px solid var(--lg);margin-bottom:8px}
.tchk{width:22px;height:22px;border:2px solid var(--mg);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;font-size:11px}
.tchk.done{background:var(--ink);border-color:var(--ink);color:white}
.tlbl{font-size:13px;font-weight:700}
.tlbl.done{text-decoration:line-through;color:var(--wg);font-weight:500}
.tsub{font-size:10px;color:var(--wg);margin-top:1px}
.tdel{background:none;border:none;color:var(--wg);font-size:16px;cursor:pointer;padding:3px;margin-left:auto}

/* REMINDERS */
.rrow{display:flex;align-items:center;gap:10px;padding:12px 13px;border-radius:var(--r);background:white;border:1px solid var(--lg);border-left:3px solid var(--red);margin-bottom:8px}
.rico{width:38px;height:38px;border-radius:10px;background:var(--red-bg);color:var(--red);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.rbody{flex:1}
.rtit{font-weight:700;font-size:13px;margin-bottom:1px}
.rtim{font-size:10px;color:var(--wg)}
.rdel{background:none;border:none;color:var(--wg);font-size:16px;cursor:pointer}

/* WISHLIST */
.wcard{display:flex;gap:11px;padding:12px;border-radius:var(--r);background:white;border:1px solid var(--lg);margin-bottom:8px}
.wico{width:64px;height:64px;border-radius:var(--r);flex-shrink:0;background:linear-gradient(135deg,#ffecd2,#fcb69f30);display:flex;align-items:center;justify-content:center;font-size:28px;border:1px solid var(--mg)}
.winfo{flex:1}
.wtit{font-weight:700;font-size:14px;margin-bottom:2px}
.wpr{color:var(--red);font-weight:800;font-size:15px;margin-bottom:2px}
.wlnk{font-size:10px;color:var(--blue);word-break:break-all;text-decoration:none}
.wfor{font-size:10px;color:var(--wg);margin-top:2px}
.wbtn{padding:5px 10px;border-radius:7px;border:none;cursor:pointer;font-size:11px;font-weight:800;font-family:'Nunito',sans-serif;transition:all .2s;align-self:flex-start;flex-shrink:0}
.wbtn.buy{background:var(--red);color:white}
.wbtn.got{background:var(--lg);color:var(--wg)}
.btag{display:inline-block;background:var(--lg);color:var(--wg);font-size:9px;font-weight:800;padding:1px 5px;border-radius:7px;margin-left:4px;letter-spacing:.2px}

/* LOCATIONS */
.loclist{display:flex;flex-direction:column;gap:7px}
.locitem{display:flex;align-items:center;gap:10px;padding:12px 13px;border-radius:var(--r);background:white;border:1px solid var(--lg)}
.locpin{width:36px;height:36px;border-radius:9px;background:#dfeeff;color:var(--blue);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.locname{font-weight:700;font-size:13px;flex:1}
.locbadge{font-size:9px;color:var(--wg);font-weight:600;background:var(--lg);padding:2px 6px;border-radius:6px}
.locdel{background:none;border:none;color:var(--wg);font-size:16px;cursor:pointer}

/* FAB - redesigned panel */
.fabwrap{position:absolute;bottom:90px;right:15px;display:flex;flex-direction:column;align-items:flex-end;gap:0;z-index:90}
.fabmain{width:54px;height:54px;border-radius:50%;background:var(--ink);color:white;border:none;font-size:22px;cursor:pointer;box-shadow:var(--s3);display:flex;align-items:center;justify-content:center;transition:transform .28s cubic-bezier(.34,1.56,.64,1),background .2s;position:relative;z-index:2}
.fabmain.open{transform:rotate(45deg)}
.fabmain:active{transform:scale(.93)}
.fabmain.open:active{transform:rotate(45deg) scale(.93)}
.fabtray{position:absolute;bottom:62px;right:0;background:white;border-radius:var(--rl);box-shadow:var(--s3);border:1px solid var(--lg);overflow:hidden;max-height:0;opacity:0;transition:max-height .38s cubic-bezier(.4,0,.2,1),opacity .25s ease;min-width:210px;transform-origin:bottom right}
.fabtray.open{max-height:700px;opacity:1}
.tsec{padding:7px 0}
.tsec+.tsec{border-top:1px solid var(--lg)}
.tlabel{font-size:9px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:var(--wg);padding:3px 13px 3px}
.titem{display:flex;align-items:center;gap:9px;padding:9px 13px;cursor:pointer;transition:background .15s;border:none;background:none;width:100%;text-align:left;font-family:'Nunito',sans-serif}
.titem:active{background:var(--lg)}
.tico{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.tname{font-size:13px;font-weight:700;color:var(--ink)}
.tsub{font-size:10px;color:var(--wg)}

/* MODAL */
.modal{display:none;position:absolute;inset:0;background:rgba(0,0,0,.42);z-index:200;align-items:flex-end;justify-content:center}
.modal.on{display:flex}
.mbox{background:var(--paper);width:100%;border-radius:var(--rx) var(--rx) 0 0;padding:22px 19px 30px;animation:shup .3s cubic-bezier(.32,1.2,.64,1);max-height:90vh;overflow-y:auto}
@keyframes shup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.mttl{font-family:'Fraunces',serif;font-size:25px;font-weight:300}
.mcls{background:var(--lg);border:none;font-size:16px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--wg);transition:background .2s}
.mcls:active{background:var(--mg)}
.frow{margin-bottom:14px}
.frow label{display:block;margin-bottom:5px;font-size:10px;font-weight:800;letter-spacing:.6px;text-transform:uppercase;color:var(--wg)}
.frow input,.frow textarea,.frow select{width:100%;padding:12px 13px;border:1.5px solid var(--mg);border-radius:var(--r);font-size:15px;font-family:'Nunito',sans-serif;background:var(--cream);transition:border .2s}
.frow input:focus,.frow textarea:focus,.frow select:focus{outline:none;border-color:var(--ink)}
.frow textarea{resize:vertical;min-height:78px}
.madd{width:100%;padding:14px;background:var(--ink);color:white;border:none;border-radius:var(--r);font-size:15px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;transition:opacity .2s,transform .15s;margin-top:3px}
.madd:active{transform:scale(.98)}
.mcan{width:100%;padding:12px;background:var(--lg);color:var(--ink);border:none;border-radius:var(--r);font-size:14px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer;margin-top:8px}
.pprev{width:100%;height:180px;border-radius:var(--r);background:var(--lg);display:flex;align-items:center;justify-content:center;margin-bottom:11px;overflow:hidden}
.pprev img{width:100%;height:100%;object-fit:cover}
.ppick{width:100%;padding:12px;border:2px dashed var(--mg);border-radius:var(--r);background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-size:13px;color:var(--wg);margin-bottom:11px;transition:border-color .2s;font-family:'Nunito',sans-serif;font-weight:700}
.ppick:active{border-color:var(--ink);background:var(--cream)}
.imgmod{display:none;position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:9999;align-items:center;justify-content:center;padding:20px}
.imgmod.on{display:flex}
.imgmod img{max-width:100%;max-height:90vh;object-fit:contain;border-radius:7px}
.imgcls{position:absolute;top:17px;right:17px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.12);border:none;color:white;font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-16px);background:var(--ink);color:white;padding:10px 19px;border-radius:20px;font-size:13px;font-weight:700;z-index:9999;opacity:0;transition:all .27s;box-shadow:var(--s3);pointer-events:none;white-space:nowrap}
.toast.on{transform:translateX(-50%) translateY(0);opacity:1}
.empty{text-align:center;padding:50px 20px;color:var(--wg)}
.ei{font-size:46px;margin-bottom:13px;display:block}
.empty h3{font-family:'Fraunces',serif;font-size:20px;color:var(--ink);font-weight:300;margin-bottom:4px}
.empty p{font-size:12px}
.pull{text-align:center;padding:13px;color:var(--wg);font-size:12px;display:none;font-weight:600}
.pull.on{display:block}
.spin{display:inline-block;width:15px;height:15px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:white;animation:sr .7s linear infinite}
@keyframes sr{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="wrap">

<!-- SPLASH -->
<div id="splash">
  <img src="kin.png" alt="KiN" class="slogo">
  <div class="sfam">The Kawa Family</div>
</div>

<!-- LOGIN -->
<div id="login">
  <div class="lwrap">
    <img src="kin.png" alt="KiN" class="llogo">
    <div class="lh">Welcome Home</div>
    <div class="ls">The Kawa Family Portal</div>
    <div class="field">
      <label>Username</label>
      <input type="text" id="uname" placeholder="Kawa" autocomplete="username">
    </div>
    <div class="field">
      <label>Your Name</label>
      <input type="password" id="pword" placeholder="Baba ¬∑ Mama ¬∑ Amelle ¬∑ Elissa" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="remrow">
      <input type="checkbox" id="remcb" checked>
      <label for="remcb" style="cursor:pointer">Remember me</label>
    </div>
    <button class="lbtn" onclick="doLogin()">Enter KiN ‚Üí</button>
    <div class="lhint">Username: Kawa &nbsp;¬∑&nbsp; Password: your name</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="hdr">
    <div class="hrow">
      <div class="hl">
        <button class="hbtn" onclick="goHome()">üè†</button>
        <img src="kin.png" alt="KiN" class="hlogo">
        <div class="ldot" id="ldot" title="Sync status"></div>
      </div>
      <div class="hr">
        <span class="utag" id="utag"></span>
        <button class="ibtn" onclick="installApp()" id="instbtn" style="display:none">üì≤</button>
        <button class="ibtn" onclick="showNotifs()" id="nbtn">üîî<span class="nbdge" id="nbdge">0</span></button>
        <button class="ibtn" onclick="doLogout()">‚Üí</button>
      </div>
    </div>
  </div>

  <div id="body">
    <div class="pull" id="pull">‚¨á Pull to refresh</div>

    <!-- FEED -->
    <div class="sec on" id="feed-sec">
      <select class="fsel" id="feed-flt" onchange="filterFeed(this.value)">
        <option value="all">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Everyone</option>
        <option value="baba">üë§ Baba</option>
        <option value="mama">üë§ Mama</option>
        <option value="amelle">üë§ Amelle</option>
        <option value="elissa">üë§ Elissa</option>
      </select>
      <div id="feed-list" class="feed-list"></div>
    </div>

    <!-- NOTES -->
    <div class="sec" id="notes-sec">
      <div class="sch">Family Notes</div>
      <div id="notes-list"></div>
    </div>

    <!-- CHAT -->
    <div class="sec" id="messages-sec">
      <div class="sch">üí¨ Family Chat</div>
      <select class="fsel" id="chat-flt" onchange="renderChat()">
        <option value="all">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Group Chat</option>
        <option value="baba">üí¨ With Baba</option>
        <option value="mama">üí¨ With Mama</option>
        <option value="amelle">üí¨ With Amelle</option>
        <option value="elissa">üí¨ With Elissa</option>
      </select>
      <div id="chat-list" class="cmsgs"></div>
    </div>

    <!-- REMINDERS -->
    <div class="sec" id="reminders-sec">
      <div class="sch">Reminders</div>
      <div id="remind-list"></div>
    </div>

    <!-- WISHLIST -->
    <div class="sec" id="wishlists-sec">
      <select class="fsel" id="wish-flt" onchange="renderWishlist()">
        <option value="all">üéÅ All Wishlists</option>
        <option value="baba">üéÅ Baba</option>
        <option value="mama">üéÅ Mama</option>
        <option value="amelle">üéÅ Amelle</option>
        <option value="elissa">üéÅ Elissa</option>
      </select>
      <div id="wish-list"></div>
    </div>

    <!-- CALENDAR -->
    <div class="sec" id="calendar-sec">
      <div class="sch">Family Calendar</div>
      <div class="calhdr">
        <div class="calmon" id="cmon">February 2026</div>
        <div class="calnav">
          <button onclick="chMon(-1)">‚Üê</button>
          <button onclick="chMon(1)">‚Üí</button>
        </div>
      </div>
      <div class="cgrid" id="cgrid"></div>
      <div style="font-family:'Fraunces',serif;font-size:17px;font-weight:300;margin:6px 0 12px">Upcoming Events</div>
      <div id="ev-list"></div>
    </div>

    <!-- TASKS -->
    <div class="sec" id="actions-sec">
      <div class="sch">Action Lists</div>
      <select class="fsel" id="task-flt" onchange="renderTasks()">
        <option value="all">‚úÖ All Tasks</option>
        <option value="baba">‚úÖ Baba</option>
        <option value="mama">‚úÖ Mama</option>
        <option value="amelle">‚úÖ Amelle</option>
        <option value="elissa">‚úÖ Elissa</option>
      </select>
      <div id="task-list"></div>
    </div>

    <!-- LOCATIONS -->
    <div class="sec" id="locations-sec">
      <div class="sch">üìç Our Places</div>
      <div id="loc-list" class="loclist"></div>
      <button class="madd" style="margin-top:13px" onclick="openModal('location')">+ Add Location</button>
    </div>
  </div>

  <!-- FAB -->
  <div class="fabwrap">
    <div class="fabtray" id="fabtray">
      <div class="tsec">
        <div class="tlabel">Share</div>
        <button class="titem" onclick="openPhotoModal()"><div class="tico" style="background:#e3f2fd">üì∑</div><div><div class="tname">Take Photo</div><div class="tsub">Post to family feed</div></div></button>
        <button class="titem" onclick="openModal('feed')"><div class="tico" style="background:#f3e5f5">üí≠</div><div><div class="tname">Post Update</div><div class="tsub">Share a thought or news</div></div></button>
        <button class="titem" onclick="openModal('note')"><div class="tico" style="background:#fff8e1">üíå</div><div><div class="tname">Send Note</div><div class="tsub">Private family note</div></div></button>
        <button class="titem" onclick="goChat()"><div class="tico" style="background:#fce4ec">üí¨</div><div><div class="tname">Chat</div><div class="tsub">Group or direct message</div></div></button>
      </div>
      <div class="tsec">
        <div class="tlabel">Plan</div>
        <button class="titem" onclick="openModal('reminder')"><div class="tico" style="background:#fbe9e7">‚è∞</div><div><div class="tname">Reminder</div><div class="tsub">Set an alert</div></div></button>
        <button class="titem" onclick="openModal('event')"><div class="tico" style="background:#e0f2f1">üìÖ</div><div><div class="tname">Add Event</div><div class="tsub">Family calendar</div></div></button>
        <button class="titem" onclick="openModal('task')"><div class="tico" style="background:#f1f8e9">‚úÖ</div><div><div class="tname">Add Task</div><div class="tsub">Create an action item</div></div></button>
      </div>
      <div class="tsec">
        <div class="tlabel">More</div>
        <button class="titem" onclick="openModal('wishlist')"><div class="tico" style="background:#fce4ec">üéÅ</div><div><div class="tname">Add to Wishlist</div><div class="tsub">Add something you want</div></div></button>
        <button class="titem" onclick="gotoLoc()"><div class="tico" style="background:#dfeeff">üìç</div><div><div class="tname">Locations</div><div class="tsub">Our family places</div></div></button>
      </div>
    </div>
    <button class="fabmain" onclick="toggleFab()" id="fabmain">+</button>
  </div>
</div><!-- /app -->

<!-- BOTTOM NAV -->
<nav class="bnav">
  <div class="nrow">
    <button class="ni on" onclick="showSection('feed')" id="nav-feed">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
      Feed<span class="nbdg" id="fbdg">0</span>
    </button>
    <button class="ni" onclick="showSection('notes')" id="nav-notes">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Notes
    </button>
    <button class="ni" onclick="showSection('messages')" id="nav-messages">
      <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
      Chat<span class="nbdg" id="cbdg">0</span>
    </button>
    <button class="ni" onclick="showSection('reminders')" id="nav-reminders">
      <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      Alerts
    </button>
    <button class="ni" onclick="showSection('wishlists')" id="nav-wishlists">
      <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      Wishlist
    </button>
    <button class="ni" onclick="showSection('calendar')" id="nav-calendar">
      <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Calendar
    </button>
  </div>
</nav>

<!-- PHOTO MODAL -->
<div class="modal" id="photo-modal" onclick="if(event.target===this)closePhotoModal()">
  <div class="mbox">
    <div class="mhd"><div class="mttl">üì∏ Add Photo</div><button class="mcls" onclick="closePhotoModal()">‚úï</button></div>
    <div class="pprev" id="pprev"><span style="font-size:38px">üì∑</span></div>
    <input type="file" id="pinput" style="display:none" accept="image/*" capture="environment" onchange="onPhotoSel(event)">
    <button class="ppick" onclick="document.getElementById('pinput').click()">üì∑ Take Photo or Choose from Library</button>
    <div class="frow"><label>Caption</label><input type="text" id="pcap" placeholder="What's happening?"></div>
    <div class="frow"><label>Location (optional)</label><select id="ploc"><option value="">No location</option></select></div>
    <button class="madd" onclick="sharePhoto()" id="sbtn">Share to Feed</button>
    <button class="mcan" onclick="closePhotoModal()">Cancel</button>
  </div>
</div>

<!-- ADD MODAL -->
<div class="modal" id="add-modal" onclick="if(event.target===this)closeModal()">
  <div class="mbox">
    <div class="mhd"><div class="mttl" id="mttl">Add New</div><button class="mcls" onclick="closeModal()">‚úï</button></div>
    <div class="frow" id="fr-for"><label>For</label>
      <select id="ifor">
        <option value="all">Everyone</option>
        <option value="baba">Baba</option>
        <option value="mama">Mama</option>
        <option value="amelle">Amelle</option>
        <option value="elissa">Elissa</option>
      </select>
    </div>
    <div class="frow"><label id="ilbl">Title</label><input type="text" id="ititle" placeholder="What's on your mind?"></div>
    <div class="frow" id="fr-type" style="display:none"><label>Type</label>
      <select id="itype"><option value="">Select type‚Ä¶</option></select>
    </div>
    <div class="frow" id="fr-loc" style="display:none"><label>Location (optional)</label>
      <select id="iloc"><option value="">No specific location</option></select>
    </div>
    <div class="frow" id="fr-price" style="display:none"><label>Price (¬£)</label><input type="number" id="iprice" placeholder="0.00" step="0.01"></div>
    <div class="frow" id="fr-link" style="display:none"><label>Link (URL)</label><input type="url" id="ilink" placeholder="https://..."></div>
    <div class="frow" id="fr-date"><label>Date</label><input type="date" id="idate"></div>
    <div class="frow" id="fr-note" style="display:none"><label>Message</label><textarea id="inote" placeholder="Write your message‚Ä¶"></textarea></div>
    <button class="madd" onclick="addItem()">Add to KiN</button>
    <button class="mcan" onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- IMAGE VIEWER -->
<div class="imgmod" id="imgmod" onclick="closeImg()">
  <button class="imgcls" onclick="closeImg()">‚úï</button>
  <img src="" id="imgbig" alt="">
</div>

<div class="toast" id="toast"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ‚îÄ‚îÄ FIREBASE CONFIG ‚Äî replace with yours ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FB = {
  apiKey:"YOUR_API_KEY",
  authDomain:"YOUR_PROJECT.firebaseapp.com",
  databaseURL:"https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId:"YOUR_PROJECT",
  storageBucket:"YOUR_PROJECT.appspot.com",
  messagingSenderId:"YOUR_SENDER_ID",
  appId:"YOUR_APP_ID"
};

// ‚îÄ‚îÄ FAMILY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const USERS  = {Baba:'baba',Mama:'mama',Amelle:'amelle',Elissa:'elissa'};
const DISP   = {baba:'Baba',mama:'Mama',amelle:'Amelle',elissa:'Elissa'};

const TYPES_EVENT = [
  {v:'Elissa School',l:'üè´ Elissa School'},{v:'Amelle School',l:'üè´ Amelle School'},
  {v:'Baba Work',l:'üíº Baba Work'},{v:'Mama Home',l:'üè† Mama Home'},
  {v:'Family',l:'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family'},{v:'Medical',l:'‚öïÔ∏è Medical'},
  {v:'Sport',l:'‚öΩ Sport'},{v:'Travel',l:'‚úàÔ∏è Travel'},
  {v:'Birthday',l:'üéÇ Birthday'},{v:'Other',l:'üìå Other'}
];
const TYPES_REMIND = [
  {v:'Elissa School',l:'üè´ Elissa School'},{v:'Amelle School',l:'üè´ Amelle School'},
  {v:'Baba Work',l:'üíº Baba Work'},{v:'Mama Home',l:'üè† Mama Home'},
  {v:'Medical',l:'‚öïÔ∏è Medical'},{v:'Pickup',l:'üöó Pickup'},
  {v:'Appointment',l:'üìã Appointment'},{v:'Other',l:'üìå Other'}
];
const TYPES_TASK = [
  {v:'Elissa School',l:'üè´ Elissa School'},{v:'Amelle School',l:'üè´ Amelle School'},
  {v:'Baba Work',l:'üíº Baba Work'},{v:'Mama Home',l:'üè† Mama Home'},
  {v:'Shopping',l:'üõí Shopping'},{v:'Errand',l:'üö∂ Errand'},
  {v:'Home',l:'üè† Home'},{v:'Other',l:'üìå Other'}
];

const DEFAULT_LOCS = [
  {id:'am-school',name:'Amersham School',icon:'üè´',custom:false},
  {id:'gxce',name:'GXCE School',icon:'üè´',custom:false},
  {id:'keith',name:'Keith House',icon:'üè†',custom:false},
  {id:'luma',name:'Luma House',icon:'üè†',custom:false},
  {id:'dadi',name:'Dadi House',icon:'üè°',custom:false},
  {id:'jidhu',name:'Jidhu House',icon:'üè°',custom:false},
  {id:'westfield',name:'Westfield',icon:'üõç',custom:false},
  {id:'gx-hs',name:'GX High Street',icon:'üõí',custom:false},
  {id:'gx-ma',name:'GX Martial Arts',icon:'ü•ã',custom:false},
  {id:'gx-swim',name:'GX Swimming',icon:'üèä',custom:false},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let CU=localStorage.getItem('kin_u2')||null;
let feedFlt='all',modalType='feed',photoData=null;
let calMon=new Date(),dp,touchY=0;
let lsm=parseInt(localStorage.getItem('kin_lsm')||'0');
let lsf=parseInt(localStorage.getItem('kin_lsf')||'0');
let fbOk=false,db=null;

function ld(k){try{return JSON.parse(localStorage.getItem('kin_d_'+k)||'[]')}catch{return[]}}
const D={
  feed:ld('feed'),notes:ld('notes'),messages:ld('messages'),
  reminders:ld('reminders'),wishlist:ld('wishlist'),events:ld('events'),
  tasks:ld('tasks'),
  locations:ld('locations').length?ld('locations'):JSON.parse(JSON.stringify(DEFAULT_LOCS))
};

// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initFB(){
  try{
    if(FB.apiKey==='YOUR_API_KEY'){console.warn('KiN: Add Firebase config for real-time sync');return}
    firebase.initializeApp(FB);
    db=firebase.database();fbOk=true;
    document.getElementById('ldot').classList.add('go');
    ['feed','notes','messages','reminders','wishlist','events','tasks','locations'].forEach(k=>{
      db.ref('kawa/'+k).on('value',s=>{
        const v=s.val();
        if(v)D[k]=Array.isArray(v)?v.filter(Boolean):Object.values(v).filter(Boolean);
        renderAll();updateBadges();populateLocs();
      });
    });
  }catch(e){console.warn('Firebase:',e)}
}

function save(k){
  if(fbOk&&db){const o={};D[k].forEach((x,i)=>o[i]=x);db.ref('kawa/'+k).set(o).catch(console.error)}
  else localStorage.setItem('kin_d_'+k,JSON.stringify(D[k]));
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  if(localStorage.getItem('kin_rem')==='true'){
    document.getElementById('uname').value=localStorage.getItem('kin_su')||'';
    document.getElementById('pword').value=localStorage.getItem('kin_sp')||'';
    document.getElementById('remcb').checked=true;
  }
  initFB();populateLocs();
  const sp=document.getElementById('splash');
  setTimeout(()=>{sp.style.opacity='0';setTimeout(()=>{sp.classList.add('gone');CU?bootApp():document.getElementById('login').classList.add('on')},850)},2500);
  setupPull();
});

function bootApp(){
  document.getElementById('app').classList.add('on');
  document.getElementById('utag').textContent=DISP[CU]||CU;
  genCal();renderAll();updateBadges();
  setInterval(updateBadges,7000);
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doLogin(){
  const u=document.getElementById('uname').value.trim();
  const p=document.getElementById('pword').value.trim();
  const rem=document.getElementById('remcb').checked;
  if(u.toLowerCase()!=='kawa'){toast('Username must be "Kawa"');return}
  const k=Object.keys(USERS).find(n=>n.toLowerCase()===p.toLowerCase());
  if(!k){toast('Password = your name üòä');return}
  CU=USERS[k];localStorage.setItem('kin_u2',CU);
  if(rem){localStorage.setItem('kin_rem','true');localStorage.setItem('kin_su',u);localStorage.setItem('kin_sp',p)}
  else{localStorage.removeItem('kin_rem');localStorage.removeItem('kin_su');localStorage.removeItem('kin_sp')}
  document.getElementById('login').classList.remove('on');bootApp();
}
function doLogout(){
  CU=null;localStorage.removeItem('kin_u2');
  document.getElementById('app').classList.remove('on');
  document.getElementById('login').classList.add('on');
  if(localStorage.getItem('kin_rem')!=='true'){document.getElementById('uname').value='';document.getElementById('pword').value=''}
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSection(s){
  document.querySelectorAll('.sec').forEach(e=>e.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(e=>e.classList.remove('on'));
  document.getElementById(s+'-sec').classList.add('on');
  const n=document.getElementById('nav-'+s);if(n)n.classList.add('on');
  closeFab();
  if(s==='messages'){clearCBdg();renderChat()}
  if(s==='locations')renderLocs();
}
function goHome(){showSection('feed');feedFlt='all';document.getElementById('feed-flt').value='all';renderFeed()}
function goChat(){closeFab();showSection('messages')}
function gotoLoc(){closeFab();showSection('locations')}

// ‚îÄ‚îÄ FAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFab(){const t=document.getElementById('fabtray'),b=document.getElementById('fabmain');const o=t.classList.toggle('open');b.classList.toggle('open',o)}
function closeFab(){document.getElementById('fabtray').classList.remove('open');document.getElementById('fabmain').classList.remove('open')}
document.addEventListener('click',e=>{const t=document.getElementById('fabtray'),b=document.getElementById('fabmain');if(t.classList.contains('open')&&!t.contains(e.target)&&e.target!==b)closeFab()});

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),3000)}
function dsp(u){return DISP[u]||u}
function ago(ts){
  const s=Math.floor((Date.now()-ts)/1000);if(s<60)return'Just now';
  const m=Math.floor(s/60);if(m<60)return m+'m ago';
  const h=Math.floor(m/60);if(h<24)return h+'h ago';
  const d=Math.floor(h/24);if(d<7)return d+'d ago';
  return new Date(ts).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
}
function chip(t){const map={feed:'üì∏ Photo',note:'üíå Note',message:'üí¨ Chat',reminder:'‚è∞',wishlist:'üéÅ Wish',event:'üìÖ Event',task:'‚úÖ Task',general:'üìå'};return`<span class="fchip">${map[t]||'üìå'}</span>`}
function locchip(l){return l?`<span class="floc">üìç ${l}</span>`:''}
function typeRowCls(it){const m={School:'school',Work:'work',Home:'home',Travel:'travel',Sport:'sport',Medical:'medical'};for(const k in m)if(it&&it.includes(k))return m[k];return''}

// ‚îÄ‚îÄ LOCATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateLocs(){
  const opts=D.locations.map(l=>`<option value="${l.name}">${l.icon} ${l.name}</option>`).join('');
  const addO='<option value="__add__">‚ûï Add New Location</option>';
  ['ploc','iloc'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const v=el.value;
    el.innerHTML='<option value="">No location</option>'+opts+addO;
    if(v)el.value=v;
  });
}
function renderLocs(){
  const c=document.getElementById('loc-list');
  if(!D.locations.length){c.innerHTML='<div class="empty"><span class="ei">üìç</span><h3>No locations</h3><p>Add your family places!</p></div>';return}
  c.innerHTML=D.locations.map((l,i)=>`
    <div class="locitem">
      <div class="locpin">${l.icon||'üìç'}</div>
      <div class="locname">${l.name}</div>
      ${l.custom?'<span class="locbadge">Custom</span>':''}
      ${l.custom?`<button class="locdel" onclick="delLoc(${i})">√ó</button>`:''}
    </div>`).join('');
}
function delLoc(i){if(!confirm('Remove location?'))return;D.locations.splice(i,1);save('locations');populateLocs();renderLocs()}
function addLoc(name){
  if(!name.trim())return;
  const icons=['üè†','üè´','üõç','‚öΩ','üèä','ü•ã','üè°','üåø','üè•','üé≠','üè™','‚õΩ'];
  D.locations.push({id:'c'+Date.now(),name:name.trim(),icon:icons[Math.floor(Math.random()*icons.length)],custom:true});
  save('locations');populateLocs();renderLocs();toast('üìç Location saved!');
}
document.addEventListener('change',e=>{
  if((e.target.id==='ploc'||e.target.id==='iloc')&&e.target.value==='__add__'){
    const n=prompt('Enter location name:');
    if(n){addLoc(n);setTimeout(()=>{e.target.value=n},100)}else e.target.value='';
  }
});

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(){renderFeed();renderNotes();renderChat();renderReminders();renderWishlist();renderEvents();renderTasks()}

function renderFeed(){
  const c=document.getElementById('feed-list');
  let acts=[];
  D.feed.forEach(f=>acts.push({ts:f.timestamp,user:f.author,verb:'shared an update',text:f.text,image:f.image,loc:f.loc,type:'feed'}));
  D.notes.forEach(n=>acts.push({ts:n.timestamp,user:n.from,verb:'sent a note to '+(n.to==='all'?'everyone':dsp(n.to)),text:n.text,type:'note'}));
  D.messages.filter(m=>m.to==='all').forEach(m=>acts.push({ts:m.timestamp,user:m.from,verb:'sent a group message',text:m.text,type:'message'}));
  D.tasks.filter(t=>t.completedAt).forEach(t=>acts.push({ts:t.completedAt,user:t.completedBy||'family',verb:'completed a task',text:t.title,type:'task'}));
  D.events.forEach(e=>acts.push({ts:e.timestamp||0,user:e.author||'family',verb:'added an event',text:e.title,type:'event'}));
  const seen=new Set();
  acts=acts.filter(a=>{const k=a.ts+'|'+a.user+'|'+a.type+'|'+(a.text||'').slice(0,18);if(seen.has(k))return false;seen.add(k);return true});
  if(feedFlt!=='all')acts=acts.filter(a=>a.user===feedFlt);
  acts.sort((a,b)=>b.ts-a.ts);
  if(!acts.length){c.innerHTML='<div class="empty"><span class="ei">üì±</span><h3>No activity yet</h3><p>Be the first to share!</p></div>';return}
  c.innerHTML=acts.map(a=>{
    const hasI=a.image&&a.image.startsWith('data:');
    return`<div class="fcard">
      <div class="av ${a.user}">${dsp(a.user).charAt(0)}</div>
      <div class="fbody">
        <div class="ftop"><span class="fn">${dsp(a.user)}</span><span class="fv">${a.verb}</span><span class="ft">${ago(a.ts)}</span></div>
        <div class="ftext">${a.text||''}</div>
        ${hasI?`<img class="fimg" src="${a.image}" onclick="openImg('${a.image}')" alt="">`:''}
        <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:3px">${chip(a.type)}${locchip(a.loc)}</div>
      </div></div>`;
  }).join('');
}
function filterFeed(v){feedFlt=v;renderFeed()}

function renderNotes(){
  const c=document.getElementById('notes-list');
  if(!D.notes.length){c.innerHTML='<div class="empty"><span class="ei">üíå</span><h3>No notes yet</h3><p>Leave a message!</p></div>';return}
  c.innerHTML=[...D.notes].sort((a,b)=>b.timestamp-a.timestamp).map((n,i)=>`
    <div class="ncard ${i%2===0?'lt':'dk'}">
      <button class="ndel" onclick="del('notes',${i})">√ó</button>
      <div class="nto">To: ${n.to==='all'?'Everyone':dsp(n.to)}</div>
      <div class="ntext">${n.text}</div>
      <div class="nmeta"><span>From: ${dsp(n.from)}</span><span>${new Date(n.timestamp).toLocaleDateString('en-GB')}</span></div>
    </div>`).join('');
}

function renderChat(){
  const c=document.getElementById('chat-list');
  const f=document.getElementById('chat-flt').value;
  let msgs=[...D.messages];
  if(f==='all')msgs=msgs.filter(m=>m.to==='all'||m.from===CU||m.to===CU);
  else msgs=msgs.filter(m=>(m.from===CU&&m.to===f)||(m.from===f&&m.to===CU));
  if(!msgs.length){c.innerHTML='<div class="empty"><span class="ei">üí¨</span><h3>No messages yet</h3><p>Start the conversation!</p></div>';return}
  msgs.sort((a,b)=>a.timestamp-b.timestamp);
  c.innerHTML=msgs.map(m=>{
    const out=m.from===CU;
    const t=new Date(m.timestamp).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    const dest=m.to!=='all'?` ‚Üí ${dsp(m.to)}`:'';
    return`<div class="bbl ${out?'bout':'bin'}">
      <div class="bwho">${out?'You':dsp(m.from)}${dest}</div>
      <div class="btxt">${m.text}</div>
      <div class="btime">${t}</div>
    </div>`;
  }).join('');
  setTimeout(()=>{c.scrollTop=c.scrollHeight},60);
}

function sendMsg(){
  const inp=document.getElementById('cinp');
  const txt=inp.value.trim();if(!txt)return;
  const to=document.getElementById('chat-flt').value;
  D.messages.push({timestamp:Date.now(),from:CU,to,text:txt});
  save('messages');inp.value='';renderChat();toast('üí¨ Sent!');
}
function clearCBdg(){lsm=Date.now();localStorage.setItem('kin_lsm',lsm);document.getElementById('cbdg').classList.remove('on')}

function renderReminders(){
  const c=document.getElementById('remind-list');
  if(!D.reminders.length){c.innerHTML='<div class="empty"><span class="ei">‚è∞</span><h3>No reminders</h3><p>Set your first reminder!</p></div>';return}
  c.innerHTML=[...D.reminders].sort((a,b)=>new Date(a.date)-new Date(b.date)).map((r,i)=>`
    <div class="rrow">
      <div class="rico">‚è∞</div>
      <div class="rbody">
        <div class="rtit">${r.title}${r.itype?` <em style="font-style:normal;font-size:10px;opacity:.7">${r.itype}</em>`:''}</div>
        <div class="rtim">${new Date(r.date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}${r.loc?' ¬∑ üìç '+r.loc:''} ¬∑ ${r.for==='all'?'Everyone':dsp(r.for)}</div>
      </div>
      <button class="rdel" onclick="del('reminders',${i})">√ó</button>
    </div>`).join('');
}

function renderWishlist(){
  const c=document.getElementById('wish-list');
  const f=document.getElementById('wish-flt').value;
  const items=f==='all'?D.wishlist:D.wishlist.filter(w=>w.for===f);
  if(!items.length){c.innerHTML='<div class="empty"><span class="ei">üéÅ</span><h3>Empty wishlist</h3><p>Add your first wish!</p></div>';return}
  c.innerHTML=items.map((w,i)=>`
    <div class="wcard">
      <div class="wico">üéÅ</div>
      <div class="winfo">
        <div class="wtit">${w.title}${w.bought?'<span class="btag">BOUGHT</span>':''}</div>
        <div class="wpr">¬£${w.price||'0'}</div>
        ${w.link?`<a href="${w.link}" target="_blank" class="wlnk">${w.link}</a>`:''}
        <div class="wfor">${dsp(w.for)}'s List</div>
      </div>
      ${CU!==w.for?`<button class="wbtn ${w.bought?'got':'buy'}" onclick="togBought(${i})">${w.bought?'‚úì Got it':'Buy'}</button>`:''}
    </div>`).join('');
}

function genCal(){
  const g=document.getElementById('cgrid');g.innerHTML='';
  ['S','M','T','W','T','F','S'].forEach(d=>{const e=document.createElement('div');e.className='cdh';e.textContent=d;g.appendChild(e)});
  const y=calMon.getFullYear(),m=calMon.getMonth();
  const dim=new Date(y,m+1,0).getDate(),fd=new Date(y,m,1).getDay();
  document.getElementById('cmon').textContent=calMon.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  for(let i=0;i<fd;i++)g.appendChild(document.createElement('div'));
  const td=new Date();
  for(let i=1;i<=dim;i++){
    const e=document.createElement('div');e.className='cd';
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
    if(D.events.some(ev=>ev.date===ds))e.classList.add('hase');
    if(i===td.getDate()&&m===td.getMonth()&&y===td.getFullYear())e.classList.add('today');
    e.textContent=i;g.appendChild(e);
  }
}
function chMon(d){calMon.setMonth(calMon.getMonth()+d);genCal()}

function renderEvents(){
  const c=document.getElementById('ev-list');
  if(!D.events.length){c.innerHTML='<div class="empty"><span class="ei">üìÖ</span><h3>No events</h3><p>Add your first event!</p></div>';return}
  c.innerHTML=[...D.events].sort((a,b)=>new Date(a.date)-new Date(b.date)).map((ev,i)=>{
    const d=new Date(ev.date);const cls=typeRowCls(ev.itype);
    return`<div class="evrow ${cls}">
      <div class="evd"><div class="evday">${d.getDate()}</div><div class="evmon">${d.toLocaleDateString('en-GB',{month:'short'})}</div></div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:13px">${ev.title}</div>
        <div style="font-size:10px;color:var(--wg)">${ev.itype||'General'} ¬∑ ${ev.for==='all'?'Everyone':dsp(ev.for)}${ev.loc?' ¬∑ üìç '+ev.loc:''}</div>
      </div>
      <button class="evdel" onclick="del('events',${i})">√ó</button>
    </div>`;
  }).join('');
}

function renderTasks(){
  const c=document.getElementById('task-list');
  const f=document.getElementById('task-flt').value;
  const items=f==='all'?D.tasks:D.tasks.filter(t=>t.for===f);
  if(!items.length){c.innerHTML='<div class="empty"><span class="ei">‚úÖ</span><h3>No tasks</h3><p>Create your first task!</p></div>';return}
  c.innerHTML=items.map((t,i)=>`
    <div class="trow">
      <div class="tchk ${t.completed?'done':''}" onclick="togTask(${i})">${t.completed?'‚úì':''}</div>
      <div style="flex:1">
        <div class="tlbl ${t.completed?'done':''}">${t.title}${t.itype?` <span style="font-size:9px;color:var(--wg)">(${t.itype})</span>`:''}</div>
        <div class="tsub">For: ${t.for==='all'?'Everyone':dsp(t.for)}${t.loc?' ¬∑ üìç '+t.loc:''}</div>
      </div>
      <button class="tdel" onclick="del('tasks',${i})">√ó</button>
    </div>`).join('');
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togTask(i){const t=D.tasks[i];t.completed=!t.completed;if(t.completed){t.completedAt=Date.now();t.completedBy=CU}else{delete t.completedAt;delete t.completedBy}save('tasks');renderTasks();renderFeed();toast(t.completed?'‚úÖ Done!':'‚Ü© Reopened')}
function togBought(i){D.wishlist[i].bought=!D.wishlist[i].bought;save('wishlist');renderWishlist();toast(D.wishlist[i].bought?'üõç Marked bought!':'Updated')}
function del(k,i){if(!confirm('Delete?'))return;D[k].splice(i,1);save(k);renderAll()}

// ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPhotoModal(){closeFab();photoData=null;document.getElementById('pprev').innerHTML='<span style="font-size:38px">üì∑</span>';document.getElementById('pcap').value='';populateLocs();document.getElementById('photo-modal').classList.add('on')}
function closePhotoModal(){document.getElementById('photo-modal').classList.remove('on')}
function onPhotoSel(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{photoData=ev.target.result;document.getElementById('pprev').innerHTML=`<img src="${photoData}">`};r.readAsDataURL(f)}
function sharePhoto(){
  if(!photoData){toast('Please select a photo first');return}
  const cap=document.getElementById('pcap').value.trim();
  const loc=document.getElementById('ploc').value;
  const btn=document.getElementById('sbtn');btn.innerHTML='<span class="spin"></span> Sharing‚Ä¶';btn.disabled=true;
  setTimeout(()=>{
    D.feed.push({timestamp:Date.now(),author:CU,for:'all',text:cap||'üì∏ Shared a photo',image:photoData,loc:loc||null});
    save('feed');renderAll();closePhotoModal();btn.textContent='Share to Feed';btn.disabled=false;photoData=null;toast('üì∏ Shared!');
  },400);
}
function openImg(s){document.getElementById('imgbig').src=s;document.getElementById('imgmod').classList.add('on')}
function closeImg(){document.getElementById('imgmod').classList.remove('on')}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(type){
  closeFab();modalType=type;
  const tt={feed:'üìù Post Update',note:'üíå Send Note',reminder:'‚è∞ Reminder',wishlist:'üéÅ Add Wish',event:'üìÖ Add Event',task:'‚úÖ Add Task',location:'üìç Add Location'};
  document.getElementById('mttl').textContent=tt[type]||'Add';
  document.getElementById('idate').valueAsDate=new Date();
  document.getElementById('ifor').value=CU||'all';
  populateLocs();

  const sh=(id,v)=>document.getElementById(id).style.display=v?'block':'none';
  sh('fr-for',['note','task'].includes(type));
  sh('fr-type',['reminder','event','task'].includes(type));
  sh('fr-loc',['reminder','event','task','feed'].includes(type));
  sh('fr-price',type==='wishlist');
  sh('fr-link',type==='wishlist'||type==='feed');
  sh('fr-note',type==='note');
  sh('fr-date',!['note','feed','location'].includes(type));

  if(type==='location'){sh('fr-for',false);sh('fr-type',false);sh('fr-loc',false);document.getElementById('ilbl').textContent='Location Name'}
  else document.getElementById('ilbl').textContent=type==='note'?'Note Title':'Title / Description';

  // Populate type dropdown
  const ts=document.getElementById('itype');
  const typeLists={event:TYPES_EVENT,reminder:TYPES_REMIND,task:TYPES_TASK};
  const tl=typeLists[type]||[];
  ts.innerHTML='<option value="">Select type‚Ä¶</option>'+tl.map(x=>`<option value="${x.v}">${x.l}</option>`).join('');

  ['ititle','iprice','ilink','inote'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  document.getElementById('itype').value='';
  document.getElementById('iloc').value='';
  document.getElementById('add-modal').classList.add('on');
}
function closeModal(){document.getElementById('add-modal').classList.remove('on')}

function addItem(){
  const fp=document.getElementById('ifor').value;
  const title=document.getElementById('ititle').value.trim();
  const itype=document.getElementById('itype').value;
  const iloc=document.getElementById('iloc').value;
  const price=document.getElementById('iprice').value;
  const link=document.getElementById('ilink').value.trim();
  const date=document.getElementById('idate').value;
  const note=document.getElementById('inote').value.trim();
  const user=CU||'baba';const ts=Date.now();

  if(modalType==='location'){if(!title){toast('Please enter a name');return}addLoc(title);closeModal();return}
  if(!title&&!note){toast('Please enter a title');return}

  switch(modalType){
    case'feed':D.feed.push({timestamp:ts,author:user,for:'all',text:title,link,loc:iloc||null});save('feed');toast('üìù Posted!');break;
    case'note':D.notes.push({timestamp:ts,text:note||title,to:fp||'all',from:user});save('notes');toast('üíå Note sent!');break;
    case'reminder':D.reminders.push({timestamp:ts,title,date:date||new Date().toISOString().split('T')[0],for:user,itype,loc:iloc||null});save('reminders');toast('‚è∞ Set!');break;
    case'wishlist':D.wishlist.push({timestamp:ts,title,price:price||'0',link,bought:false,for:user});save('wishlist');toast('üéÅ Added!');break;
    case'event':D.events.push({timestamp:ts,title,date:date||new Date().toISOString().split('T')[0],itype,for:'all',author:user,loc:iloc||null});save('events');genCal();toast('üìÖ Event added!');break;
    case'task':D.tasks.push({timestamp:ts,title,completed:false,for:fp||user,itype,loc:iloc||null});save('tasks');toast('‚úÖ Created!');break;
  }
  renderAll();closeModal();
}

// ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateBadges(){
  if(!CU)return;
  const nm=D.messages.filter(m=>m.timestamp>lsm&&m.from!==CU).length;
  const cb=document.getElementById('cbdg');if(nm>0){cb.textContent=nm;cb.classList.add('on')}else cb.classList.remove('on');
  const nf=D.feed.filter(f=>f.timestamp>lsf&&f.author!==CU).length;
  const fb=document.getElementById('fbdg');if(nf>0){fb.textContent=nf;fb.classList.add('on')}else fb.classList.remove('on');
}
function showNotifs(){
  const msgs=D.messages.filter(m=>m.timestamp>lsm&&m.from!==CU);
  const feeds=D.feed.filter(f=>f.timestamp>lsf&&f.author!==CU);
  if(!msgs.length&&!feeds.length){toast('All caught up! ‚ú®');return}
  let t='üîî What you missed:\n\n';
  feeds.forEach(f=>t+=`üì∏ ${dsp(f.author)}: ${f.text}\n`);
  msgs.forEach(m=>t+=`üí¨ ${dsp(m.from)}: ${m.text}\n`);
  alert(t);
  lsm=Date.now();lsf=Date.now();
  localStorage.setItem('kin_lsm',lsm);localStorage.setItem('kin_lsf',lsf);
  updateBadges();
}

// ‚îÄ‚îÄ PULL TO REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupPull(){
  const b=document.getElementById('body'),ind=document.getElementById('pull');
  b.addEventListener('touchstart',e=>{if(b.scrollTop===0)touchY=e.touches[0].clientY},{passive:true});
  b.addEventListener('touchmove',e=>{if(b.scrollTop===0){const d=e.touches[0].clientY-touchY;if(d>0&&d<80){ind.classList.add('on');ind.style.transform=`translateY(${d/2}px)`}}},{passive:true});
  b.addEventListener('touchend',e=>{const d=e.changedTouches[0].clientY-touchY;if(d>70&&b.scrollTop===0){ind.textContent='üîÑ Refreshing‚Ä¶';setTimeout(()=>{renderAll();ind.classList.remove('on');ind.textContent='‚¨á Pull to refresh';ind.style.transform='';toast('Refreshed!')},700)}else{ind.classList.remove('on');ind.style.transform=''}});
}

// ‚îÄ‚îÄ PWA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dp=e;document.getElementById('instbtn').style.display='flex'});
function installApp(){if(dp){dp.prompt();dp.userChoice.then(r=>{if(r.outcome==='accepted')document.getElementById('instbtn').style.display='none';dp=null})}else alert('Tap Share ‚Üí Add to Home Screen')}
if('serviceWorker'in navigator)navigator.serviceWorker.register('service-worker.js');

// Chat enter key
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.activeElement&&document.activeElement.id==='cinp')sendMsg()});
// Prevent double-tap zoom
let lt=0;document.addEventListener('touchend',e=>{const n=Date.now();if(n-lt<=300)e.preventDefault();lt=n},false);
</script>
</body>
</html>